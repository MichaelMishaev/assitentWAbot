<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>דוח אישי - בדיקה</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#667eea',
            secondary: '#764ba2',
          }
        }
      }
    }
  </script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .fade-in { animation: fadeIn 0.5s ease-out; }
    .slide-in { animation: slideInRight 0.4s ease-out; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
    }
    .modal.active {
      display: flex;
      align-items: center;
      justify-center;
      padding: 16px;
    }
    .modal-content {
      background: white;
      border-radius: 28px;
      max-width: 700px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50 min-h-screen">

  <!-- Header -->
  <header class="gradient-bg text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <div class="flex flex-col gap-3">
        <div class="flex items-center justify-center md:justify-start">
          <h1 class="text-3xl md:text-4xl font-bold flex items-center gap-3">
            <span>📊</span>
            <span>דוח אישי - בדיקה</span>
          </h1>
        </div>
        <p class="text-purple-100 text-sm md:text-base">בדיקת תצוגת אירועי העבר והסטטיסטיקות</p>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8">

    <!-- Test Controls (hidden when using real token) -->
    <div id="test-controls" class="glass rounded-2xl shadow-xl p-6 mb-6 fade-in">
      <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        <span>🧪</span>
        <span>בקרות בדיקה</span>
      </h2>

      <div class="flex flex-wrap gap-3">
        <button
          onclick="loadWithMockData()"
          class="px-6 py-3 rounded-xl font-bold bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:shadow-lg transition-all">
          📦 טען נתוני ניסיון
        </button>
        <button
          onclick="loadWithRealAPI()"
          class="px-6 py-3 rounded-xl font-bold bg-gradient-to-r from-blue-500 to-indigo-600 text-white hover:shadow-lg transition-all">
          🔌 טען מה-API
        </button>
        <button
          onclick="clearData()"
          class="px-6 py-3 rounded-xl font-bold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all">
          🗑️ נקה
        </button>
      </div>

      <!-- Token Input (for API testing) -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">טוקן (לבדיקת API)</label>
        <input
          type="text"
          id="token-input"
          placeholder="הכנס טוקן מהדשבורד..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        />
      </div>
    </div>

    <!-- Search & Filter Section -->
    <div id="search-section" class="glass rounded-2xl shadow-xl p-6 mb-6 hidden">
      <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        <span>🔍</span>
        <span>חיפוש</span>
      </h2>

      <div class="flex gap-3">
        <!-- Keyword Search -->
        <div class="flex-1">
          <input
            type="text"
            id="search-keyword"
            placeholder="חפש לפי כותרת, מיקום או הערות..."
            oninput="applyFilters()"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-base"
          />
        </div>

        <!-- Clear Button -->
        <button
          onclick="clearFilters()"
          class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 font-medium transition-all whitespace-nowrap">
          נקה
        </button>
      </div>

      <!-- Filter Results Count -->
      <div id="filter-results" class="mt-3 text-sm text-gray-600 hidden"></div>
    </div>

    <!-- Top Locations (MOVED TO TOP - First section after controls) -->
    <div id="locations-section" class="glass rounded-2xl shadow-xl p-6 mb-6 slide-in hidden">
      <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        <span>📍</span>
        <span>מיקומים פופולריים</span>
        <span class="text-sm text-gray-500 font-normal">(לחץ למיקום לפרטים)</span>
      </h2>
      <div id="locations-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
        <!-- Locations will be populated here -->
      </div>
    </div>

    <!-- Stats Summary (MOVED AFTER Locations) -->
    <div id="stats-section" class="glass rounded-2xl shadow-xl p-6 mb-6 slide-in hidden" style="animation-delay: 0.1s">
      <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        <span>📈</span>
        <span>סיכום אירועי העבר</span>
      </h2>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="glass rounded-xl p-4 border-r-4 border-purple-500">
          <div class="text-3xl mb-2">🎯</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-total">0</div>
          <div class="text-sm text-gray-600">סה"כ אירועים</div>
        </div>
        <div class="glass rounded-xl p-4 border-r-4 border-blue-500">
          <div class="text-3xl mb-2">📍</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-locations">0</div>
          <div class="text-sm text-gray-600">מיקומים</div>
        </div>
        <div class="glass rounded-xl p-4 border-r-4 border-green-500">
          <div class="text-3xl mb-2">📊</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-avg">0</div>
          <div class="text-sm text-gray-600">ממוצע ליום</div>
        </div>
        <div class="glass rounded-xl p-4 border-r-4 border-amber-500">
          <div class="text-3xl mb-2">📅</div>
          <div class="text-sm font-bold text-gray-800" id="stat-period">-</div>
          <div class="text-xs text-gray-600">תקופה</div>
        </div>
      </div>
    </div>

    <!-- Recent Events -->
    <div id="events-section" class="glass rounded-2xl shadow-xl p-6 slide-in hidden" style="animation-delay: 0.2s">
      <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        <span>🗂️</span>
        <span>אירועים אחרונים</span>
        <span class="text-sm text-gray-500 font-normal">(לחץ לאירוע לפרטים)</span>
      </h2>
      <div id="events-list" class="space-y-3">
        <!-- Events will be populated here -->
      </div>
    </div>

    <!-- Link to Detailed Report (only shown in test mode without token) -->

  </div>

  <!-- Modal for Drill-downs -->
  <div id="detailModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div id="modalBody">
        <!-- Modal content will be injected here -->
      </div>
    </div>
  </div>

  <script>
    // Token injected from server
    const INJECTED_TOKEN = '{{TOKEN}}';

    // Store all events globally for drill-downs
    let allEvents = [];
    let filteredEvents = [];

    // Mock data generator
    function generateMockData() {
      const events = [];
      const titles = ['פגישה עם לקוח', 'ישיבת צוות', 'אירוע חברתי', 'מפגש עסקי', 'כנס טכנולוגיה', 'הרצאה', 'ארוחת צהריים עסקית', 'הצגת מוצר', 'סדנת פיתוח', 'מפגש לקוחות'];
      const locations = ['משרד ראשי', 'תל אביב', 'ירושלים', 'חיפה', 'בית קפה סנטרל', 'מרכז העיר', 'רמת גן', 'הרצליה', 'פתח תקווה', 'נתניה'];

      for (let i = 0; i < 50; i++) {
        const daysAgo = Math.floor(Math.random() * 90) + 1; // 1-90 days ago
        const date = new Date();
        date.setDate(date.getDate() - daysAgo);
        date.setHours(9 + Math.floor(Math.random() * 9), Math.floor(Math.random() * 60), 0, 0);

        const location = locations[Math.floor(Math.random() * locations.length)];
        events.push({
          id: `event-${i}`,
          title: `${titles[Math.floor(Math.random() * titles.length)]} ${i + 1}`,
          startTsUtc: date.toISOString(),
          location: location,
          notes: i % 3 === 0 ? `הערות לאירוע מספר ${i}` : null,
          participants: i % 2 === 0 ? Math.floor(Math.random() * 10) + 2 : null
        });
      }

      return events.sort((a, b) => new Date(b.startTsUtc) - new Date(a.startTsUtc));
    }

    function calculateStats(events) {
      if (!events || events.length === 0) {
        return null;
      }

      const dates = events.map(e => new Date(e.startTsUtc));
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));
      const daysDiff = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) || 1;

      const locationCounts = {};
      events.forEach(e => {
        if (e.location) {
          locationCounts[e.location] = (locationCounts[e.location] || 0) + 1;
        }
      });

      const topLocations = Object.entries(locationCounts)
        .map(([location, count]) => ({ location, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);

      return {
        totalCount: events.length,
        dateRange: {
          start: minDate,
          end: maxDate
        },
        topLocations,
        averageEventsPerDay: (events.length / daysDiff).toFixed(2)
      };
    }

    function renderStats(stats) {
      if (!stats) return;

      document.getElementById('stat-total').textContent = stats.totalCount;
      document.getElementById('stat-avg').textContent = stats.averageEventsPerDay;
      document.getElementById('stat-locations').textContent = stats.topLocations?.length || 0;

      if (stats.dateRange) {
        const start = new Date(stats.dateRange.start).toLocaleDateString('he-IL');
        const end = new Date(stats.dateRange.end).toLocaleDateString('he-IL');
        document.getElementById('stat-period').textContent = `${start} - ${end}`;
      }

      document.getElementById('stats-section').classList.remove('hidden');
    }

    function renderLocations(locations) {
      const container = document.getElementById('locations-list');

      if (!locations || locations.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-500">אין מיקומים</div>';
        return;
      }

      container.innerHTML = locations.map(loc => `
        <div onclick="drillDownLocation('${loc.location.replace(/'/g, "\\'")}')"
             class="bg-white rounded-lg p-4 flex items-center justify-between hover:shadow-lg transition-all cursor-pointer hover:bg-purple-50 border-2 border-transparent hover:border-purple-300">
          <div class="flex items-center gap-3">
            <div class="text-2xl">📍</div>
            <div>
              <div class="font-bold text-gray-800">${loc.location}</div>
              <div class="text-sm text-gray-500">${loc.count} אירועים</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="text-2xl font-bold text-purple-600">${loc.count}</div>
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </div>
      `).join('');

      document.getElementById('locations-section').classList.remove('hidden');
    }

    function renderEvents(events) {
      const container = document.getElementById('events-list');

      if (!events || events.length === 0) {
        container.innerHTML = `
          <div class="text-center py-16 text-gray-400">
            <div class="text-6xl mb-4">📭</div>
            <div class="text-xl font-bold">אין אירועי עבר</div>
          </div>`;
        return;
      }

      // Show search section when we have events
      document.getElementById('search-section').classList.remove('hidden');

      container.innerHTML = events.map((event, idx) => {
        const date = new Date(event.startTsUtc);
        const dateStr = date.toLocaleDateString('he-IL', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        const timeStr = date.toLocaleTimeString('he-IL', {
          hour: '2-digit',
          minute: '2-digit'
        });

        return `
          <div onclick='drillDownEvent(${JSON.stringify(event).replace(/'/g, "\\'")})'
               class="bg-gradient-to-br from-blue-50 via-indigo-50 to-blue-50 rounded-2xl p-5 border-r-4 border-blue-400 card-hover shadow-sm cursor-pointer hover:shadow-xl hover:border-blue-600"
               style="animation: slideInRight 0.4s ease-out ${idx * 0.05}s both;">
            <div class="flex items-start gap-3">
              <div class="text-2xl">📅</div>
              <div class="flex-1">
                <div class="font-bold text-gray-900 text-lg mb-1">${event.title}</div>
                <div class="flex flex-wrap gap-2 text-sm text-gray-600">
                  <span>📅 ${dateStr}</span>
                  <span>🕐 ${timeStr}</span>
                  ${event.location ? `<span>📍 ${event.location}</span>` : ''}
                </div>
              </div>
              <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </div>
          </div>`;
      }).join('');

      document.getElementById('events-section').classList.remove('hidden');
    }

    // Drill-down: Show all events at specific location
    function drillDownLocation(location) {
      const locationEvents = allEvents.filter(e => e.location === location);

      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <div class="gradient-bg p-8 text-white">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-3xl font-bold flex items-center gap-3">
              <span>📍</span>
              <span>${location}</span>
            </h2>
            <button onclick="closeModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div class="text-5xl font-bold">${locationEvents.length}</div>
          <div class="text-purple-100">אירועים במיקום זה</div>
        </div>
        <div class="p-6 max-h-[50vh] overflow-y-auto space-y-3">
          ${locationEvents.map(event => {
            const date = new Date(event.startTsUtc);
            return `
              <div class="bg-blue-50 rounded-lg p-4 border-r-4 border-blue-400">
                <div class="font-bold text-gray-900">${event.title}</div>
                <div class="text-sm text-gray-600 mt-1">
                  📅 ${date.toLocaleDateString('he-IL')} •
                  🕐 ${date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}
                </div>
                ${event.notes ? `<div class="text-sm text-gray-500 mt-2">💬 ${event.notes}</div>` : ''}
              </div>
            `;
          }).join('')}
        </div>
      `;

      document.getElementById('detailModal').classList.add('active');
    }

    // Drill-down: Show event details
    function drillDownEvent(event) {
      const date = new Date(event.startTsUtc);
      const dateStr = date.toLocaleDateString('he-IL', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      const timeStr = date.toLocaleTimeString('he-IL', {
        hour: '2-digit',
        minute: '2-digit'
      });

      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <div class="gradient-bg p-8 text-white">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold">פרטי אירוע</h2>
            <button onclick="closeModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="p-8">
          <div class="mb-6">
            <div class="text-3xl mb-2">📅</div>
            <h3 class="text-2xl font-bold text-gray-900 mb-4">${event.title}</h3>
          </div>

          <div class="space-y-4">
            <div class="flex items-start gap-3">
              <span class="text-2xl">📅</span>
              <div>
                <div class="font-bold text-gray-700">תאריך</div>
                <div class="text-gray-600">${dateStr}</div>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <span class="text-2xl">🕐</span>
              <div>
                <div class="font-bold text-gray-700">שעה</div>
                <div class="text-gray-600">${timeStr}</div>
              </div>
            </div>

            ${event.location ? `
              <div class="flex items-start gap-3">
                <span class="text-2xl">📍</span>
                <div>
                  <div class="font-bold text-gray-700">מיקום</div>
                  <div class="text-gray-600">${event.location}</div>
                </div>
              </div>
            ` : ''}

            ${event.participants ? `
              <div class="flex items-start gap-3">
                <span class="text-2xl">👥</span>
                <div>
                  <div class="font-bold text-gray-700">משתתפים</div>
                  <div class="text-gray-600">${event.participants} אנשים</div>
                </div>
              </div>
            ` : ''}

            ${event.notes ? `
              <div class="flex items-start gap-3">
                <span class="text-2xl">💬</span>
                <div>
                  <div class="font-bold text-gray-700">הערות</div>
                  <div class="text-gray-600">${event.notes}</div>
                </div>
              </div>
            ` : ''}
          </div>

          <div class="mt-8 pt-6 border-t">
            <button onclick="closeModal()" class="w-full px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl font-bold hover:shadow-lg transition-all">
              סגור
            </button>
          </div>
        </div>
      `;

      document.getElementById('detailModal').classList.add('active');
    }

    function closeModal(event) {
      if (!event || event.target.id === 'detailModal' || event.type === 'click') {
        document.getElementById('detailModal').classList.remove('active');
      }
    }

    function loadWithMockData() {
      console.log('Loading with mock data...');
      allEvents = generateMockData();
      const stats = calculateStats(allEvents);

      renderStats(stats);
      renderLocations(stats.topLocations);
      renderEvents(allEvents);
    }

    async function loadWithRealAPI(autoToken = null) {
      const token = autoToken || document.getElementById('token-input')?.value.trim() || '';

      if (!token) {
        alert('❌ נא להזין טוקן מהדשבורד');
        return;
      }

      console.log('Loading with real API...');

      try {
        const response = await fetch(`/api/dashboard/${token}/past-events?includeStats=true&groupBy=month&limit=50`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Failed to load data');
        }

        const { events, stats } = result.data;
        allEvents = events;

        renderStats(stats);
        renderLocations(stats.topLocations);
        renderEvents(events);

        console.log('✅ Data loaded successfully from API');
      } catch (error) {
        console.error('Failed to load from API:', error);
        alert(`❌ שגיאה בטעינה מה-API: ${error.message}`);
      }
    }

    function clearData() {
      allEvents = [];
      filteredEvents = [];
      document.getElementById('stats-section').classList.add('hidden');
      document.getElementById('locations-section').classList.add('hidden');
      document.getElementById('events-section').classList.add('hidden');
      document.getElementById('search-section').classList.add('hidden');
      console.log('Data cleared');
    }

    // Filter events based on search criteria
    function applyFilters() {
      const keyword = document.getElementById('search-keyword')?.value?.toLowerCase().trim() || '';

      if (!keyword) {
        // No filter - show all events
        clearFilters();
        return;
      }

      console.log('Filtering with keyword:', keyword);

      filteredEvents = allEvents.filter(event => {
        // Search in title, location, and notes (safely convert to string)
        const titleMatch = String(event.title || '').toLowerCase().includes(keyword);
        const locationMatch = String(event.location || '').toLowerCase().includes(keyword);
        const notesMatch = String(event.notes || '').toLowerCase().includes(keyword);

        return titleMatch || locationMatch || notesMatch;
      });

      console.log('Filtered results:', filteredEvents.length, 'out of', allEvents.length);

      // Update results count
      const resultsDiv = document.getElementById('filter-results');
      resultsDiv.classList.remove('hidden');
      resultsDiv.textContent = `נמצאו ${filteredEvents.length} אירועים מתוך ${allEvents.length}`;

      // Re-calculate stats and locations for filtered events
      const stats = calculateStats(filteredEvents);

      // Re-render all sections with filtered data
      renderStats(stats);
      renderLocations(stats?.topLocations || []);
      renderEvents(filteredEvents);
    }

    // Clear all filters
    function clearFilters() {
      const searchInput = document.getElementById('search-keyword');
      if (searchInput) {
        searchInput.value = '';
      }

      document.getElementById('filter-results').classList.add('hidden');

      filteredEvents = [];

      // Re-calculate stats for all events
      const stats = calculateStats(allEvents);

      // Re-render all sections with full data
      renderStats(stats);
      renderLocations(stats?.topLocations || []);
      renderEvents(allEvents);
    }

    // Auto-load data on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Check if we have a real token injected from server
      if (INJECTED_TOKEN && INJECTED_TOKEN.trim() !== '') {
        console.log('🚀 Auto-loading REAL data with token...');
        // Hide test controls when using real token
        document.getElementById('test-controls').classList.add('hidden');
        // Update detailed report link to include token
        const detailedLink = document.getElementById('detailed-report-link');
        if (detailedLink) {
          detailedLink.href = `/past-events-report/${INJECTED_TOKEN}`;
        }
        // Load real data
        loadWithRealAPI(INJECTED_TOKEN);
      } else {
        console.log('🧪 Test mode - no token. Showing test controls.');
        // In test mode, don't auto-load anything - let user choose
      }
    });
  </script>

</body>
</html>
