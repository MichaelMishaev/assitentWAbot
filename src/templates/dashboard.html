<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×”×œ×•×— ×”××™×©×™ ×©×œ×™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#667eea',
            secondary: '#764ba2',
          }
        }
      }
    }
  </script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .fade-in { animation: fadeIn 0.5s ease-out; }
    .skeleton { animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    .priority-urgent { border-right: 4px solid #ef4444; }
    .priority-high { border-right: 4px solid #f59e0b; }
    .priority-normal { border-right: 4px solid #3b82f6; }
    .priority-low { border-right: 4px solid #10b981; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .calendar-day {
      min-height: 100px;
      transition: all 0.2s ease;
    }
    .calendar-day:hover {
      background: rgba(102, 126, 234, 0.05);
      transform: scale(1.02);
    }
    .calendar-today {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border: 2px solid #667eea;
    }
    .event-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
      margin: 0 1px;
    }
    .event-item {
      font-size: 0.7rem;
      padding: 2px 4px;
      border-radius: 4px;
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50 min-h-screen">

  <!-- Loading Screen -->
  <div id="loading" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
    <div class="text-center">
      <div class="text-6xl mb-4 animate-bounce">ğŸ“Š</div>
      <div class="text-white text-2xl font-bold mb-4">×˜×•×¢×Ÿ ××ª ×”×œ×•×— ×©×œ×š...</div>
      <div class="flex gap-2 justify-center">
        <div class="w-3 h-3 bg-white rounded-full skeleton"></div>
        <div class="w-3 h-3 bg-white rounded-full skeleton" style="animation-delay: 0.2s"></div>
        <div class="w-3 h-3 bg-white rounded-full skeleton" style="animation-delay: 0.4s"></div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="content" class="hidden">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
      <div class="container mx-auto px-4 py-6">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h1 class="text-3xl md:text-4xl font-bold flex items-center gap-3">
              <span>ğŸ“Š</span>
              <span>×”×œ×•×— ×”××™×©×™ ×©×œ×™</span>
            </h1>
            <p class="text-purple-100 mt-2" id="currentDate"></p>
          </div>
          <div class="flex items-center gap-3 bg-white/20 px-4 py-2 rounded-full">
            <span class="text-sm">â°</span>
            <span class="text-sm font-medium" id="expiryTimer">×˜×•×¢×Ÿ...</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Stats Cards -->
    <div class="container mx-auto px-4 -mt-8 mb-8">
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <!-- Stat Card Template -->
        <div class="glass rounded-2xl p-4 shadow-lg card-hover">
          <div class="text-3xl mb-2">ğŸ“…</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-events">0</div>
          <div class="text-sm text-gray-600">××™×¨×•×¢×™×</div>
        </div>
        <div class="glass rounded-2xl p-4 shadow-lg card-hover">
          <div class="text-3xl mb-2">ğŸ—“ï¸</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-today">0</div>
          <div class="text-sm text-gray-600">×”×™×•×</div>
        </div>
        <div class="glass rounded-2xl p-4 shadow-lg card-hover">
          <div class="text-3xl mb-2">â°</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-reminders">0</div>
          <div class="text-sm text-gray-600">×ª×–×›×•×¨×•×ª</div>
        </div>
        <div class="glass rounded-2xl p-4 shadow-lg card-hover">
          <div class="text-3xl mb-2">ğŸ””</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-upcoming">0</div>
          <div class="text-sm text-gray-600">×§×¨×•×‘×•×ª</div>
        </div>
        <div class="glass rounded-2xl p-4 shadow-lg card-hover">
          <div class="text-3xl mb-2">âœ…</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-tasks">0</div>
          <div class="text-sm text-gray-600">××©×™××•×ª</div>
        </div>
        <div class="glass rounded-2xl p-4 shadow-lg card-hover">
          <div class="text-3xl mb-2">ğŸ¯</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-completed">0</div>
          <div class="text-sm text-gray-600">×”×•×©×œ××•</div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="container mx-auto px-4 mb-6">
      <div class="glass rounded-2xl p-2 shadow-lg inline-flex gap-2 flex-wrap">
        <button onclick="showTab('calendar')" id="tab-calendar" class="px-6 py-3 rounded-xl font-medium transition-all bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-lg">
          ğŸ“† ×œ×•×— ×©× ×”
        </button>
        <button onclick="showTab('events')" id="tab-events" class="px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100">
          ğŸ“… ××™×¨×•×¢×™×
        </button>
        <button onclick="showTab('reminders')" id="tab-reminders" class="px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100">
          â° ×ª×–×›×•×¨×•×ª
        </button>
        <button onclick="showTab('tasks')" id="tab-tasks" class="px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100">
          âœ… ××©×™××•×ª
        </button>
      </div>
    </div>

    <!-- Content Sections -->
    <div class="container mx-auto px-4 pb-12">

      <!-- Calendar Section -->
      <div id="section-calendar" class="fade-in">
        <div class="glass rounded-2xl shadow-xl p-4 md:p-8">
          <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
              <span>ğŸ“†</span>
              <span>×œ×•×— ×”×©× ×” ×©×œ×™</span>
            </h2>
            <div class="flex items-center gap-2">
              <button onclick="changeMonth(-1)" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-lg font-medium transition-all">
                â†
              </button>
              <span id="calendar-month-year" class="text-lg font-bold text-gray-700 px-4"></span>
              <button onclick="changeMonth(1)" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-lg font-medium transition-all">
                â†’
              </button>
              <button onclick="goToToday()" class="bg-gradient-to-r from-purple-500 to-indigo-600 hover:shadow-lg text-white px-4 py-2 rounded-lg font-medium transition-all mr-2">
                ×”×™×•×
              </button>
            </div>
          </div>

          <!-- Calendar Legend -->
          <div class="flex flex-wrap gap-4 mb-6 text-sm">
            <div class="flex items-center gap-2">
              <div class="event-dot bg-blue-500"></div>
              <span class="text-gray-600">××™×¨×•×¢</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="event-dot bg-amber-500"></div>
              <span class="text-gray-600">×ª×–×›×•×¨×ª</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="event-dot bg-green-500"></div>
              <span class="text-gray-600">××©×™××”</span>
            </div>
          </div>

          <!-- Calendar Grid -->
          <div class="overflow-x-auto">
            <div class="min-w-full">
              <!-- Day Headers -->
              <div class="grid grid-cols-7 gap-1 mb-2">
                <div class="text-center font-bold text-gray-700 py-2">×¨××©×•×Ÿ</div>
                <div class="text-center font-bold text-gray-700 py-2">×©× ×™</div>
                <div class="text-center font-bold text-gray-700 py-2">×©×œ×™×©×™</div>
                <div class="text-center font-bold text-gray-700 py-2">×¨×‘×™×¢×™</div>
                <div class="text-center font-bold text-gray-700 py-2">×—××™×©×™</div>
                <div class="text-center font-bold text-gray-700 py-2">×©×™×©×™</div>
                <div class="text-center font-bold text-gray-700 py-2">×©×‘×ª</div>
              </div>
              <!-- Calendar Days -->
              <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                <!-- Days will be generated by JavaScript -->
              </div>
            </div>
          </div>

          <!-- Selected Day Details -->
          <div id="day-details" class="mt-6 hidden">
            <div class="border-t-2 border-purple-200 pt-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>ğŸ“‹</span>
                <span id="selected-day-title"></span>
              </h3>
              <div id="day-details-content" class="space-y-3">
                <!-- Day details will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Events Section -->
      <div id="section-events" class="hidden fade-in">
        <div class="glass rounded-2xl shadow-xl p-6 md:p-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
            <span>ğŸ“…</span>
            <span>×”××™×¨×•×¢×™× ×©×œ×™</span>
          </h2>
          <div id="events-list" class="space-y-4">
            <!-- Events will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Reminders Section -->
      <div id="section-reminders" class="hidden fade-in">
        <div class="glass rounded-2xl shadow-xl p-6 md:p-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
            <span>â°</span>
            <span>×”×ª×–×›×•×¨×•×ª ×©×œ×™</span>
          </h2>
          <div id="reminders-list" class="space-y-4">
            <!-- Reminders will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Tasks Section -->
      <div id="section-tasks" class="hidden fade-in">
        <div class="glass rounded-2xl shadow-xl p-6 md:p-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
            <span>âœ…</span>
            <span>×”××©×™××•×ª ×©×œ×™</span>
          </h2>
          <div id="tasks-list" class="space-y-4">
            <!-- Tasks will be loaded here -->
          </div>
        </div>
      </div>

    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-12">
      <div class="container mx-auto px-4 text-center">
        <p class="text-gray-400">ğŸ¤– × ×•×¦×¨ ×¢×œ ×™×“×™ WhatsApp Assistant Bot</p>
        <p class="text-gray-500 text-sm mt-2">×”×§×™×©×•×¨ ×ª×§×£ ×œ-15 ×“×§×•×ª ×‘×œ×‘×“</p>
      </div>
    </footer>
  </div>

  <!-- Error Screen -->
  <div id="error" class="hidden fixed inset-0 bg-gradient-to-br from-red-50 to-red-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
      <div class="text-6xl mb-4">âš ï¸</div>
      <h1 class="text-2xl font-bold text-gray-800 mb-2">××•×¤×¡! ××©×”×• ×”×©×ª×‘×©</h1>
      <p class="text-gray-600 mb-6" id="error-message">×œ× ×”×¦×œ×—× ×• ×œ×˜×¢×•×Ÿ ××ª ×”× ×ª×•× ×™×</p>
      <button onclick="location.reload()" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
        × ×¡×” ×©×•×‘
      </button>
    </div>
  </div>

  <script>
    const TOKEN = '{{TOKEN}}';
    let data = null;
    let expiryInterval = null;

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      // Set current date
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('he-IL', options);

      // Load data
      await loadDashboardData();
    });

    async function loadDashboardData() {
      try {
        const response = await fetch(`/api/dashboard/${TOKEN}`);

        if (!response.ok) {
          throw new Error('Failed to load dashboard data');
        }

        const result = await response.json();
        data = result.data;

        // Update stats
        document.getElementById('stat-events').textContent = data.stats.totalEvents;
        document.getElementById('stat-today').textContent = data.stats.todayEvents;
        document.getElementById('stat-reminders').textContent = data.stats.totalReminders;
        document.getElementById('stat-upcoming').textContent = data.stats.upcomingReminders;
        document.getElementById('stat-tasks').textContent = data.stats.activeTasks;
        document.getElementById('stat-completed').textContent = data.stats.completedTasks;

        // Start expiry timer
        startExpiryTimer(result.expiresIn);

        // Render events
        renderEvents(data.events);
        renderReminders(data.reminders);
        renderTasks(data.tasks);

        // Initialize calendar
        initializeCalendar();

        // Show content
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showError('×œ× ×”×¦×œ×—× ×• ×œ×˜×¢×•×Ÿ ××ª ×”× ×ª×•× ×™×. ×× × × ×¡×” ×©×•×‘.');
      }
    }

    function startExpiryTimer(seconds) {
      const updateTimer = () => {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('expiryTimer').textContent =
          `×¤×’ ×ª×•×§×£ ×‘×¢×•×“ ${minutes}:${secs.toString().padStart(2, '0')}`;

        if (seconds <= 0) {
          clearInterval(expiryInterval);
          showError('×”×§×™×©×•×¨ ×¤×’ ×ª×•×§×¤×•. ×× × ×‘×§×© ×§×™×©×•×¨ ×—×“×© ××”×‘×•×˜.');
        }
        seconds--;
      };

      updateTimer();
      expiryInterval = setInterval(updateTimer, 1000);
    }

    function renderEvents(events) {
      const container = document.getElementById('events-list');

      if (events.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">ğŸ“­</div>
            <p class="text-gray-600 text-lg">××™×Ÿ ××™×¨×•×¢×™× ×§×¨×•×‘×™×</p>
          </div>
        `;
        return;
      }

      container.innerHTML = events.map(event => {
        const start = new Date(event.startTsUtc);
        const isToday = isDateToday(start);
        const isPast = start < new Date();

        return `
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 md:p-6 border-r-4 border-blue-500 card-hover ${isPast ? 'opacity-60' : ''}">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  ${isToday ? '<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold">×”×™×•×</span>' : ''}
                  ${isPast ? '<span class="bg-gray-400 text-white text-xs px-2 py-1 rounded-full">×¢×‘×¨</span>' : ''}
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">${escapeHtml(event.title)}</h3>
                <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                  <span class="flex items-center gap-1">
                    ğŸ“… ${formatDate(start)}
                  </span>
                  ${!event.isAllDay ? `<span class="flex items-center gap-1">ğŸ• ${formatTime(start)}</span>` : '<span class="flex items-center gap-1">â° ×›×œ ×”×™×•×</span>'}
                  ${event.location ? `<span class="flex items-center gap-1">ğŸ“ ${escapeHtml(event.location)}</span>` : ''}
                </div>
                ${event.notes ? `<p class="mt-3 text-gray-700 text-sm">${escapeHtml(event.notes)}</p>` : ''}
              </div>
              <div class="text-3xl">${isPast ? 'âœ“' : 'ğŸ“…'}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderReminders(reminders) {
      const container = document.getElementById('reminders-list');

      if (reminders.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">ğŸ”•</div>
            <p class="text-gray-600 text-lg">××™×Ÿ ×ª×–×›×•×¨×•×ª ×¤×¢×™×œ×•×ª</p>
          </div>
        `;
        return;
      }

      container.innerHTML = reminders.map(reminder => {
        const due = new Date(reminder.dueTsUtc);
        const isPast = due < new Date();
        const isUpcoming = !isPast && (due - new Date()) < 24 * 60 * 60 * 1000;

        return `
          <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-4 md:p-6 border-r-4 border-amber-500 card-hover ${!reminder.isActive || isPast ? 'opacity-60' : ''}">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  ${isUpcoming ? '<span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full font-bold animate-pulse">×§×¨×•×‘!</span>' : ''}
                  ${!reminder.isActive ? '<span class="bg-gray-400 text-white text-xs px-2 py-1 rounded-full">××‘×•×˜×œ</span>' : ''}
                  ${reminder.recurrence ? '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">×—×•×–×¨</span>' : ''}
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">${escapeHtml(reminder.title)}</h3>
                <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                  <span class="flex items-center gap-1">
                    ğŸ“… ${formatDate(due)}
                  </span>
                  <span class="flex items-center gap-1">
                    ğŸ• ${formatTime(due)}
                  </span>
                  ${reminder.recurrence ? `<span class="flex items-center gap-1">ğŸ”„ ${reminder.recurrence}</span>` : ''}
                </div>
              </div>
              <div class="text-3xl">â°</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTasks(tasks) {
      const container = document.getElementById('tasks-list');

      if (tasks.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <p class="text-gray-600 text-lg">×›×œ ×”××©×™××•×ª ×”×•×©×œ××•!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = tasks.map(task => {
        const priorityClass = `priority-${task.priority}`;
        const priorityEmoji = {
          urgent: 'ğŸ”´',
          high: 'ğŸŸ ',
          normal: 'ğŸ”µ',
          low: 'ğŸŸ¢'
        }[task.priority] || 'ğŸ”µ';

        const isOverdue = task.dueTsUtc && new Date(task.dueTsUtc) < new Date();

        return `
          <div class="bg-white rounded-xl p-4 md:p-6 ${priorityClass} shadow-md card-hover">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">${priorityEmoji}</span>
                  ${task.status === 'in_progress' ? '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">×‘×‘×™×¦×•×¢</span>' : ''}
                  ${isOverdue ? '<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full animate-pulse">×‘××™×—×•×¨!</span>' : ''}
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">${escapeHtml(task.title)}</h3>
                ${task.description ? `<p class="text-gray-600 text-sm mb-3">${escapeHtml(task.description)}</p>` : ''}
                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                  ${task.dueTsUtc ? `
                    <span class="flex items-center gap-1">
                      ğŸ“… ${formatDate(new Date(task.dueTsUtc))}
                    </span>
                  ` : ''}
                  <span class="flex items-center gap-1">
                    ğŸ·ï¸ ${getPriorityText(task.priority)}
                  </span>
                </div>
              </div>
              <div class="text-3xl">âœ…</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Calendar state
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDate = null;

    function showTab(tab) {
      // Hide all sections
      document.getElementById('section-calendar').classList.add('hidden');
      document.getElementById('section-events').classList.add('hidden');
      document.getElementById('section-reminders').classList.add('hidden');
      document.getElementById('section-tasks').classList.add('hidden');

      // Reset all tab buttons
      document.getElementById('tab-calendar').className = 'px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100';
      document.getElementById('tab-events').className = 'px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100';
      document.getElementById('tab-reminders').className = 'px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100';
      document.getElementById('tab-tasks').className = 'px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100';

      // Show selected section and activate tab
      document.getElementById(`section-${tab}`).classList.remove('hidden');
      document.getElementById(`tab-${tab}`).className = 'px-6 py-3 rounded-xl font-medium transition-all bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-lg';

      // If calendar tab is shown, render the calendar
      if (tab === 'calendar') {
        renderCalendar();
      }
    }

    function showError(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.add('hidden');
      document.getElementById('error-message').textContent = message;
      document.getElementById('error').classList.remove('hidden');
    }

    function formatDate(date) {
      return date.toLocaleDateString('he-IL', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function formatTime(date) {
      return date.toLocaleTimeString('he-IL', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function isDateToday(date) {
      const today = new Date();
      return date.getDate() === today.getDate() &&
             date.getMonth() === today.getMonth() &&
             date.getFullYear() === today.getFullYear();
    }

    function getPriorityText(priority) {
      const map = {
        urgent: '×“×—×•×£',
        high: '×’×‘×•×”',
        normal: '×¨×’×™×œ',
        low: '× ××•×š'
      };
      return map[priority] || '×¨×’×™×œ';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Calendar functions
    function initializeCalendar() {
      currentMonth = new Date().getMonth();
      currentYear = new Date().getFullYear();
      renderCalendar();
    }

    function renderCalendar() {
      const monthNames = [
        '×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
        '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'
      ];

      // Update month/year display
      document.getElementById('calendar-month-year').textContent =
        `${monthNames[currentMonth]} ${currentYear}`;

      // Get first day of month and number of days
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();

      // Calculate previous month's days to show
      const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
      const prevMonthDays = startingDayOfWeek;

      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';

      let dayCounter = 1;
      let nextMonthDay = 1;

      // Create 6 weeks (42 days total)
      for (let i = 0; i < 42; i++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day bg-white rounded-lg p-2 border border-gray-200 cursor-pointer';

        let currentDay, currentMonth_local, currentYear_local;
        let isCurrentMonth = false;
        let isToday = false;

        if (i < prevMonthDays) {
          // Previous month
          currentDay = prevMonthLastDay - prevMonthDays + i + 1;
          currentMonth_local = currentMonth === 0 ? 11 : currentMonth - 1;
          currentYear_local = currentMonth === 0 ? currentYear - 1 : currentYear;
          dayCell.classList.add('opacity-40');
        } else if (dayCounter <= daysInMonth) {
          // Current month
          currentDay = dayCounter;
          currentMonth_local = currentMonth;
          currentYear_local = currentYear;
          isCurrentMonth = true;
          dayCounter++;

          // Check if today
          const today = new Date();
          if (currentDay === today.getDate() &&
              currentMonth === today.getMonth() &&
              currentYear === today.getFullYear()) {
            isToday = true;
            dayCell.classList.add('calendar-today');
          }
        } else {
          // Next month
          currentDay = nextMonthDay;
          currentMonth_local = currentMonth === 11 ? 0 : currentMonth + 1;
          currentYear_local = currentMonth === 11 ? currentYear + 1 : currentYear;
          nextMonthDay++;
          dayCell.classList.add('opacity-40');
        }

        // Create date string
        const dateStr = `${currentYear_local}-${String(currentMonth_local + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;

        // Day number
        const dayNumber = document.createElement('div');
        dayNumber.className = 'font-bold text-gray-700 mb-1 text-sm';
        dayNumber.textContent = currentDay;
        dayCell.appendChild(dayNumber);

        // Get items for this day
        const dayItems = getItemsForDate(dateStr);

        // Show dots for items
        if (dayItems.events.length + dayItems.reminders.length + dayItems.tasks.length > 0) {
          const dotsContainer = document.createElement('div');
          dotsContainer.className = 'flex gap-1 mb-1 flex-wrap';

          dayItems.events.slice(0, 3).forEach(() => {
            const dot = document.createElement('div');
            dot.className = 'event-dot bg-blue-500';
            dotsContainer.appendChild(dot);
          });

          dayItems.reminders.slice(0, 3).forEach(() => {
            const dot = document.createElement('div');
            dot.className = 'event-dot bg-amber-500';
            dotsContainer.appendChild(dot);
          });

          dayItems.tasks.slice(0, 3).forEach(() => {
            const dot = document.createElement('div');
            dot.className = 'event-dot bg-green-500';
            dotsContainer.appendChild(dot);
          });

          dayCell.appendChild(dotsContainer);

          // Show first few items as mini labels (only for current month)
          if (isCurrentMonth) {
            const itemsPreview = document.createElement('div');
            itemsPreview.className = 'space-y-1';

            [...dayItems.events.slice(0, 2)].forEach(event => {
              const item = document.createElement('div');
              item.className = 'event-item bg-blue-100 text-blue-800';
              item.textContent = event.title;
              item.title = event.title;
              itemsPreview.appendChild(item);
            });

            [...dayItems.reminders.slice(0, 1)].forEach(reminder => {
              const item = document.createElement('div');
              item.className = 'event-item bg-amber-100 text-amber-800';
              item.textContent = reminder.title;
              item.title = reminder.title;
              itemsPreview.appendChild(item);
            });

            dayCell.appendChild(itemsPreview);
          }
        }

        // Click handler
        dayCell.onclick = () => showDayDetails(dateStr, currentDay, currentMonth_local, currentYear_local);

        grid.appendChild(dayCell);
      }
    }

    function getItemsForDate(dateStr) {
      const result = {
        events: [],
        reminders: [],
        tasks: []
      };

      if (!data) return result;

      // Check events
      data.events.forEach(event => {
        const eventDate = new Date(event.startTsUtc);
        const eventDateStr = `${eventDate.getFullYear()}-${String(eventDate.getMonth() + 1).padStart(2, '0')}-${String(eventDate.getDate()).padStart(2, '0')}`;
        if (eventDateStr === dateStr) {
          result.events.push(event);
        }
      });

      // Check reminders
      data.reminders.forEach(reminder => {
        const reminderDate = new Date(reminder.dueTsUtc);
        const reminderDateStr = `${reminderDate.getFullYear()}-${String(reminderDate.getMonth() + 1).padStart(2, '0')}-${String(reminderDate.getDate()).padStart(2, '0')}`;
        if (reminderDateStr === dateStr && reminder.isActive) {
          result.reminders.push(reminder);
        }
      });

      // Check tasks
      data.tasks.forEach(task => {
        if (task.dueTsUtc) {
          const taskDate = new Date(task.dueTsUtc);
          const taskDateStr = `${taskDate.getFullYear()}-${String(taskDate.getMonth() + 1).padStart(2, '0')}-${String(taskDate.getDate()).padStart(2, '0')}`;
          if (taskDateStr === dateStr) {
            result.tasks.push(task);
          }
        }
      });

      return result;
    }

    function showDayDetails(dateStr, day, month, year) {
      const monthNames = [
        '×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
        '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'
      ];

      const dayItems = getItemsForDate(dateStr);
      const total = dayItems.events.length + dayItems.reminders.length + dayItems.tasks.length;

      if (total === 0) {
        document.getElementById('day-details').classList.add('hidden');
        return;
      }

      selectedDate = dateStr;
      document.getElementById('selected-day-title').textContent =
        `${day} ×‘${monthNames[month]} ${year} (${total} ×¤×¨×™×˜×™×)`;

      const content = document.getElementById('day-details-content');
      content.innerHTML = '';

      // Show events
      dayItems.events.forEach(event => {
        const item = document.createElement('div');
        item.className = 'bg-blue-50 border-r-4 border-blue-500 rounded-lg p-3';
        item.innerHTML = `
          <div class="flex items-start gap-2">
            <span class="text-xl">ğŸ“…</span>
            <div class="flex-1">
              <div class="font-bold text-blue-900">${escapeHtml(event.title)}</div>
              <div class="text-sm text-blue-700 mt-1">
                ${event.isAllDay ? 'â° ×›×œ ×”×™×•×' : `ğŸ• ${formatTime(new Date(event.startTsUtc))}`}
                ${event.location ? `<br>ğŸ“ ${escapeHtml(event.location)}` : ''}
              </div>
            </div>
          </div>
        `;
        content.appendChild(item);
      });

      // Show reminders
      dayItems.reminders.forEach(reminder => {
        const item = document.createElement('div');
        item.className = 'bg-amber-50 border-r-4 border-amber-500 rounded-lg p-3';
        item.innerHTML = `
          <div class="flex items-start gap-2">
            <span class="text-xl">â°</span>
            <div class="flex-1">
              <div class="font-bold text-amber-900">${escapeHtml(reminder.title)}</div>
              <div class="text-sm text-amber-700 mt-1">
                ğŸ• ${formatTime(new Date(reminder.dueTsUtc))}
                ${reminder.recurrence ? `<br>ğŸ”„ ${reminder.recurrence}` : ''}
              </div>
            </div>
          </div>
        `;
        content.appendChild(item);
      });

      // Show tasks
      dayItems.tasks.forEach(task => {
        const priorityEmoji = {
          urgent: 'ğŸ”´',
          high: 'ğŸŸ ',
          normal: 'ğŸ”µ',
          low: 'ğŸŸ¢'
        }[task.priority] || 'ğŸ”µ';

        const item = document.createElement('div');
        item.className = 'bg-green-50 border-r-4 border-green-500 rounded-lg p-3';
        item.innerHTML = `
          <div class="flex items-start gap-2">
            <span class="text-xl">âœ…</span>
            <div class="flex-1">
              <div class="font-bold text-green-900">
                ${priorityEmoji} ${escapeHtml(task.title)}
              </div>
              ${task.description ? `<div class="text-sm text-green-700 mt-1">${escapeHtml(task.description)}</div>` : ''}
              <div class="text-xs text-green-600 mt-1">
                ğŸ·ï¸ ${getPriorityText(task.priority)}
              </div>
            </div>
          </div>
        `;
        content.appendChild(item);
      });

      document.getElementById('day-details').classList.remove('hidden');
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    }

    function goToToday() {
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      renderCalendar();
    }
  </script>
</body>
</html>
