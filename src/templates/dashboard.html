<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×”×œ×•×— ×”××™×©×™ ×©×œ×™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#667eea',
            secondary: '#764ba2',
          }
        }
      }
    }
  </script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .fade-in { animation: fadeIn 0.5s ease-out; }
    .skeleton { animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    .card-hover:active { transform: translateY(-2px) scale(0.98); }
    .priority-urgent { border-right: 4px solid #ef4444; }
    .priority-high { border-right: 4px solid #f59e0b; }
    .priority-normal { border-right: 4px solid #3b82f6; }
    .priority-low { border-right: 4px solid #10b981; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .calendar-day {
      min-height: 140px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    @media (max-width: 768px) {
      .calendar-day {
        min-height: 100px;
        font-size: 0.85rem;
      }
    }
    .calendar-day:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      z-index: 10;
    }
    .calendar-today {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
      border: 2px solid #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .event-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin: 0 2px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .event-item {
      font-size: 0.75rem;
      padding: 3px 6px;
      border-radius: 6px;
      margin-bottom: 3px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .event-item:hover {
      transform: translateX(-2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    @media (max-width: 768px) {
      .event-item {
        font-size: 0.65rem;
        padding: 2px 4px;
      }
      .event-dot {
        width: 6px;
        height: 6px;
        margin: 0 1px;
      }
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal-content {
      background: white;
      border-radius: 28px;
      max-width: 700px;
      width: 100%;
      max-height: 85vh;
      overflow: hidden;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.05),
        0 10px 30px -10px rgba(0, 0, 0, 0.2),
        0 30px 60px -20px rgba(0, 0, 0, 0.3);
      animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      position: relative;
    }
    @keyframes modalSlideUp {
      from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content::-webkit-scrollbar {
      width: 8px;
    }
    .modal-content::-webkit-scrollbar-track {
      background: transparent;
    }
    .modal-content::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }
    .modal-content::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }
    @media (max-width: 640px) {
      .modal.active {
        padding: 8px;
        align-items: flex-end;
      }
      .modal-content {
        border-radius: 24px 24px 0 0;
        max-height: 92vh;
        animation: modalSlideUpMobile 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      @keyframes modalSlideUpMobile {
        from {
          opacity: 0;
          transform: translateY(100%);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    }
    .clickable-card {
      cursor: pointer;
      user-select: none;
    }
    .clickable-card:active {
      transform: scale(0.98);
    }
    .week-grid {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
      gap: 0;
      background: #ffffff;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      overflow: hidden;
      min-width: 100%;
    }
    /* Mobile: ensure week grid is wide enough to show all 7 days */
    @media (max-width: 768px) {
      .week-grid {
        min-width: 800px; /* 60px time + ~105px per day column = 7*105 = 735 + 60 = 795 */
        grid-template-columns: 60px repeat(7, minmax(100px, 1fr));
      }
      #week-view-content {
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        scroll-behavior: smooth;
      }
    }
    .time-slot {
      background: #f9fafb;
      padding: 8px 4px;
      font-size: 0.7rem;
      color: #6b7280;
      text-align: right;
      border-left: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
    }
    .day-column {
      background: white;
      min-height: 60px;
      position: relative;
      padding: 0;
      border-left: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
    }
    .day-header {
      background: #f3f4f6;
      color: #374151;
      padding: 8px 4px;
      text-align: center;
      font-weight: 600;
      font-size: 0.85rem;
      border-left: 1px solid #d1d5db;
      border-bottom: 2px solid #d1d5db;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60px;
    }
    @media (max-width: 768px) {
      .day-header {
        font-size: 0.75rem;
        padding: 6px 2px;
        min-height: 50px;
      }
    }
    .day-header.today {
      background: #dbeafe;
      color: #1e40af;
      font-weight: 700;
    }
    .event-block {
      position: absolute;
      left: 2px;
      right: 2px;
      padding: 2px 4px;
      border-radius: 2px;
      font-size: 0.7rem;
      cursor: pointer;
      transition: opacity 0.15s ease;
      overflow: hidden;
      z-index: 1;
      border-left: 3px solid;
    }
    .event-block:hover {
      opacity: 0.85;
      z-index: 10;
    }
    .event-block-event {
      background: #3b82f6;
      color: white;
      border-left-color: #1e40af;
    }
    .event-block-reminder {
      background: #f59e0b;
      color: white;
      border-left-color: #b45309;
    }
    .compact-month {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      width: 100%;
      min-height: 0;
    }
    .compact-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 4px;
      min-height: 60px;
      max-height: 120px;
    }
    .compact-day:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      transform: scale(1.05);
    }
    .compact-day.today {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: bold;
    }
    .compact-day.has-events {
      border: 2px solid #667eea;
    }
    .event-count-badge {
      font-size: 0.65rem;
      background: #667eea;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      margin-top: 2px;
    }
    .filter-btn {
      opacity: 0.5;
      border: 2px solid transparent !important;
    }
    .filter-btn.filter-active {
      opacity: 1;
    }
    .collapsible-header {
      cursor: pointer;
      user-select: none;
    }
    .collapsible-header:active {
      transform: scale(0.98);
    }
    @media (max-width: 768px) {
      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .collapsible-content.expanded {
        max-height: 5000px;
        transition: max-height 0.5s ease-in;
      }
      .stats-mobile-collapsible {
        max-height: 300px;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .stats-mobile-collapsible.expanded {
        max-height: 1000px;
      }
    }
    /* Toast Notification Styles */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: white;
      border-radius: 12px;
      padding: 16px 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 9999;
      animation: slideInRight 0.3s ease-out;
      max-width: 400px;
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .toast.success { border-right: 4px solid #10b981; }
    .toast.error { border-right: 4px solid #ef4444; }
    .toast.info { border-right: 4px solid #3b82f6; }
    .toast-exit {
      animation: slideOutRight 0.3s ease-out;
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    /* Progress Bar Styles */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s ease-out;
      border-radius: 3px;
    }
    /* Stat Card Enhancement */
    .stat-card {
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.5s ease-out;
    }
    .stat-card.loaded::before {
      transform: scaleX(1);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50 min-h-screen">

  <!-- Loading Screen -->
  <div id="loading" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
    <div class="text-center">
      <div class="text-6xl mb-4 animate-bounce">ğŸ“Š</div>
      <div class="text-white text-2xl font-bold mb-4">×˜×•×¢×Ÿ ××ª ×”×œ×•×— ×©×œ×š...</div>
      <div class="flex gap-2 justify-center">
        <div class="w-3 h-3 bg-white rounded-full skeleton"></div>
        <div class="w-3 h-3 bg-white rounded-full skeleton" style="animation-delay: 0.2s"></div>
        <div class="w-3 h-3 bg-white rounded-full skeleton" style="animation-delay: 0.4s"></div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="content" class="hidden">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
      <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col gap-3">
          <!-- Title Section -->
          <div class="flex items-center justify-center md:justify-start">
            <h1 class="text-3xl md:text-4xl font-bold flex items-center gap-3">
              <span>ğŸ“Š</span>
              <span>×”×œ×•×— ×”××™×©×™ ×©×œ×™</span>
            </h1>
          </div>

          <!-- Date and Timer Section -->
          <div class="flex items-center justify-between flex-wrap gap-3">
            <p class="text-purple-100 text-sm md:text-base" id="currentDate"></p>
            <div class="flex items-center gap-2 bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-full shadow-lg">
              <span class="text-sm">â°</span>
              <span class="text-xs md:text-sm font-medium whitespace-nowrap" id="expiryTimer">×˜×•×¢×Ÿ...</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Today's Overview Smart Panel -->
    <div class="container mx-auto px-4 -mt-8 mb-6">
      <div id="today-overview" class="glass rounded-2xl shadow-xl p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <span>ğŸ¯</span>
          <span>×¡×§×™×¨×ª ×”×™×•×</span>
        </h2>
        <div id="today-content" class="space-y-3">
          <!-- Today's items will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="container mx-auto px-4 mb-8">
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <!-- Stat Card Template -->
        <div class="glass rounded-2xl p-4 shadow-lg card-hover stat-card cursor-pointer" onclick="handleStatCardClick('events')" data-card-type="events">
          <div class="text-3xl mb-2">ğŸ“…</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-events">0</div>
          <div class="text-sm text-gray-600">××™×¨×•×¢×™×</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-events" style="width: 0%"></div>
          </div>
        </div>
        <div class="glass rounded-2xl p-4 shadow-lg card-hover stat-card cursor-pointer" onclick="handleStatCardClick('today')" data-card-type="today">
          <div class="text-3xl mb-2">ğŸ—“ï¸</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-today">0</div>
          <div class="text-sm text-gray-600">×”×™×•×</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-today" style="width: 0%"></div>
          </div>
        </div>
        <div class="glass rounded-2xl p-4 shadow-lg card-hover stat-card cursor-pointer" onclick="handleStatCardClick('reminders')" data-card-type="reminders">
          <div class="text-3xl mb-2">â°</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-reminders">0</div>
          <div class="text-sm text-gray-600">×ª×–×›×•×¨×•×ª</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-reminders" style="width: 0%"></div>
          </div>
        </div>
        <div class="glass rounded-2xl p-4 shadow-lg card-hover stat-card cursor-pointer" onclick="handleStatCardClick('upcoming')" data-card-type="upcoming">
          <div class="text-3xl mb-2">ğŸ””</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-upcoming">0</div>
          <div class="text-sm text-gray-600">×§×¨×•×‘×•×ª</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-upcoming" style="width: 0%"></div>
          </div>
        </div>
        <div class="glass rounded-2xl p-4 shadow-lg card-hover stat-card cursor-pointer" onclick="handleStatCardClick('tasks')" data-card-type="tasks">
          <div class="text-3xl mb-2">âœ…</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-tasks">0</div>
          <div class="text-sm text-gray-600">××©×™××•×ª ×¤×¢×™×œ×•×ª</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-tasks" style="width: 0%"></div>
          </div>
        </div>
        <div class="glass rounded-2xl p-4 shadow-lg card-hover stat-card cursor-pointer" onclick="handleStatCardClick('completed')" data-card-type="completed">
          <div class="text-3xl mb-2">ğŸ¯</div>
          <div class="text-2xl font-bold text-gray-800" id="stat-completed">0</div>
          <div class="text-sm text-gray-600">×”×•×©×œ××•</div>
          <div class="progress-bar">
            <div class="progress-fill bg-green-500" id="progress-completed" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- Past Events Button Row -->
      <div class="mt-4 flex justify-center">
        <button onclick="showPastEventsModal()" class="glass rounded-2xl p-4 shadow-lg card-hover px-8 py-4 bg-gradient-to-r from-purple-50 to-indigo-50 hover:from-purple-100 hover:to-indigo-100 border-2 border-purple-400 transition-all">
          <div class="flex items-center gap-3">
            <span class="text-3xl">ğŸ•</span>
            <div class="text-right">
              <div class="text-xl font-bold text-gray-800">××™×¨×•×¢×™ ×”×¢×‘×¨</div>
              <div class="text-sm text-gray-600">×¦×¤×™×™×” ×‘××™×¨×•×¢×™× ×©×”×™×•</div>
            </div>
          </div>
        </button>
      </div>
    </div>

    <!-- Search & Filter Bar -->
    <div class="container mx-auto px-4 mb-6">
      <div class="glass rounded-2xl shadow-lg p-4">
        <div class="flex flex-col md:flex-row gap-4 items-stretch md:items-center">
          <!-- Search Input -->
          <div class="flex-1 relative">
            <input
              type="text"
              id="search-input"
              placeholder="ğŸ” ×—×¤×© ××™×¨×•×¢×™×, ×ª×–×›×•×¨×•×ª ××• ××©×™××•×ª..."
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-purple-500 focus:outline-none transition-all"
              oninput="applyFilters()"
            />
          </div>
          <!-- Filter Buttons -->
          <div class="flex gap-2 flex-wrap">
            <button onclick="toggleFilter('events')" id="filter-events" class="filter-btn filter-active px-4 py-2 rounded-lg font-medium transition-all bg-blue-100 text-blue-700 border-2 border-blue-500">
              ğŸ“… ××™×¨×•×¢×™×
            </button>
            <button onclick="toggleFilter('reminders')" id="filter-reminders" class="filter-btn filter-active px-4 py-2 rounded-lg font-medium transition-all bg-amber-100 text-amber-700 border-2 border-amber-500">
              â° ×ª×–×›×•×¨×•×ª
            </button>
            <button onclick="toggleFilter('tasks')" id="filter-tasks" class="filter-btn filter-active px-4 py-2 rounded-lg font-medium transition-all bg-green-100 text-green-700 border-2 border-green-500">
              âœ… ××©×™××•×ª
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="container mx-auto px-4 mb-6">
      <div class="glass rounded-2xl p-2 shadow-lg inline-flex gap-2 flex-wrap">
        <button onclick="showTab('week')" id="tab-week" class="px-6 py-3 rounded-xl font-medium transition-all bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-lg">
          ğŸ“… ×©×‘×•×¢
        </button>
        <button onclick="showTab('month')" id="tab-month" class="px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100">
          ğŸ“† ×—×•×“×©
        </button>
        <button onclick="showTab('agenda')" id="tab-agenda" class="px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100">
          ğŸ“‹ ××’'× ×“×”
        </button>
        <button onclick="showTab('reminders')" id="tab-reminders" class="px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100">
          â° ×ª×–×›×•×¨×•×ª
        </button>
        <button onclick="showTab('tasks')" id="tab-tasks" class="px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100">
          âœ… ××©×™××•×ª
        </button>
      </div>
    </div>

    <!-- Content Sections -->
    <div class="container mx-auto px-4 pb-12">

      <!-- Week View Section -->
      <div id="section-week" class="fade-in">
        <div class="glass rounded-2xl shadow-xl p-4 md:p-8">
          <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
              <span>ğŸ“…</span>
              <span>×ª×¦×•×’×ª ×©×‘×•×¢</span>
            </h2>
            <div class="flex items-center gap-2" dir="ltr">
              <button onclick="changeWeek(-1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition-all">
                â†
              </button>
              <span id="week-range" class="text-lg font-bold text-gray-700 px-4" dir="rtl"></span>
              <button onclick="changeWeek(1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition-all">
                â†’
              </button>
              <button onclick="goToThisWeek()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all mr-2">
                ×”×©×‘×•×¢
              </button>
            </div>
          </div>

          <div id="week-view-content" class="overflow-x-auto">
            <!-- Week grid will be generated here -->
          </div>
        </div>
      </div>

      <!-- Month View Section -->
      <div id="section-month" class="hidden fade-in">
        <div class="glass rounded-2xl shadow-xl p-4 md:p-8">
          <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
              <span>ğŸ“†</span>
              <span>×ª×¦×•×’×ª ×—×•×“×©</span>
            </h2>
            <div class="flex items-center gap-2" dir="ltr">
              <button onclick="changeMonth(-1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition-all">
                â†
              </button>
              <span id="month-name" class="text-lg font-bold text-gray-700 px-4" dir="rtl"></span>
              <button onclick="changeMonth(1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition-all">
                â†’
              </button>
              <button onclick="goToThisMonth()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all mr-2">
                ×”×—×•×“×©
              </button>
            </div>
          </div>

          <div id="month-view-content" class="overflow-auto w-full">
            <!-- Month grid will be generated here -->
          </div>
        </div>
      </div>

      <!-- Agenda View Section -->
      <div id="section-agenda" class="hidden fade-in">
        <div class="glass rounded-2xl shadow-xl p-4 md:p-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
            <span>ğŸ“‹</span>
            <span>××’'× ×“×” - ×›×œ ×”××™×¨×•×¢×™× ×•×”×ª×–×›×•×¨×•×ª</span>
          </h2>
          <div id="agenda-list" class="space-y-4">
            <!-- Agenda items will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Old Calendar Section - Remove -->
      <div id="section-calendar" class="hidden fade-in">
        <div class="glass rounded-2xl shadow-xl p-4 md:p-8">
          <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
              <span>ğŸ“†</span>
              <span>×œ×•×— ×”×©× ×” ×©×œ×™</span>
            </h2>
            <div class="flex items-center gap-2">
              <button onclick="changeMonth(-1)" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-lg font-medium transition-all">
                â†
              </button>
              <span id="calendar-month-year" class="text-lg font-bold text-gray-700 px-4"></span>
              <button onclick="changeMonth(1)" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-lg font-medium transition-all">
                â†’
              </button>
              <button onclick="goToToday()" class="bg-gradient-to-r from-purple-500 to-indigo-600 hover:shadow-lg text-white px-4 py-2 rounded-lg font-medium transition-all mr-2">
                ×”×™×•×
              </button>
            </div>
          </div>

          <!-- Calendar Legend -->
          <div class="flex flex-wrap gap-4 mb-6 text-sm">
            <div class="flex items-center gap-2">
              <div class="event-dot bg-blue-500"></div>
              <span class="text-gray-600">××™×¨×•×¢</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="event-dot bg-amber-500"></div>
              <span class="text-gray-600">×ª×–×›×•×¨×ª</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="event-dot bg-green-500"></div>
              <span class="text-gray-600">××©×™××”</span>
            </div>
          </div>

          <!-- Calendar Grid -->
          <div class="overflow-x-auto">
            <div class="min-w-full">
              <!-- Day Headers -->
              <div class="grid grid-cols-7 gap-1 mb-2">
                <div class="text-center font-bold text-gray-700 py-2">×¨××©×•×Ÿ</div>
                <div class="text-center font-bold text-gray-700 py-2">×©× ×™</div>
                <div class="text-center font-bold text-gray-700 py-2">×©×œ×™×©×™</div>
                <div class="text-center font-bold text-gray-700 py-2">×¨×‘×™×¢×™</div>
                <div class="text-center font-bold text-gray-700 py-2">×—××™×©×™</div>
                <div class="text-center font-bold text-gray-700 py-2">×©×™×©×™</div>
                <div class="text-center font-bold text-gray-700 py-2">×©×‘×ª</div>
              </div>
              <!-- Calendar Days -->
              <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                <!-- Days will be generated by JavaScript -->
              </div>
            </div>
          </div>

          <!-- Selected Day Details -->
          <div id="day-details" class="mt-6 hidden">
            <div class="border-t-2 border-purple-200 pt-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>ğŸ“‹</span>
                <span id="selected-day-title"></span>
              </h3>
              <div id="day-details-content" class="space-y-3">
                <!-- Day details will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Events Section -->
      <div id="section-events" class="hidden fade-in">
        <div class="glass rounded-2xl shadow-xl p-6 md:p-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
            <span>ğŸ“…</span>
            <span>×”××™×¨×•×¢×™× ×©×œ×™</span>
          </h2>
          <div id="events-list" class="space-y-4">
            <!-- Events will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Reminders Section -->
      <div id="section-reminders" class="hidden fade-in">
        <div class="glass rounded-2xl shadow-xl p-6 md:p-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
            <span>â°</span>
            <span>×”×ª×–×›×•×¨×•×ª ×©×œ×™</span>
          </h2>
          <div id="reminders-list" class="space-y-4">
            <!-- Reminders will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Tasks Section -->
      <div id="section-tasks" class="hidden fade-in">
        <div class="glass rounded-2xl shadow-xl p-6 md:p-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
            <span>âœ…</span>
            <span>×”××©×™××•×ª ×©×œ×™</span>
          </h2>
          <div id="tasks-list" class="space-y-4">
            <!-- Tasks will be loaded here -->
          </div>
        </div>
      </div>

    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-12">
      <div class="container mx-auto px-4 text-center">
        <p class="text-gray-400">ğŸ¤– × ×•×¦×¨ ×¢×œ ×™×“×™ WhatsApp Assistant Bot</p>
        <p class="text-gray-500 text-sm mt-2">×”×§×™×©×•×¨ ×ª×§×£ ×œ-15 ×“×§×•×ª ×‘×œ×‘×“</p>
      </div>
    </footer>
  </div>

  <!-- Error Screen -->
  <div id="error" class="hidden fixed inset-0 bg-gradient-to-br from-red-50 to-red-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
      <div class="text-6xl mb-4">âš ï¸</div>
      <h1 class="text-2xl font-bold text-gray-800 mb-2">××•×¤×¡! ××©×”×• ×”×©×ª×‘×©</h1>
      <p class="text-gray-600 mb-6" id="error-message">×œ× ×”×¦×œ×—× ×• ×œ×˜×¢×•×Ÿ ××ª ×”× ×ª×•× ×™×</p>
      <button onclick="location.reload()" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
        × ×¡×” ×©×•×‘
      </button>
    </div>
  </div>

  <!-- Item Details Modal -->
  <div id="itemModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div id="modalBody">
        <!-- Modal content will be injected here -->
      </div>
    </div>
  </div>

  <!-- Floating Action Button (FAB) -->
  <button
    id="add-fab"
    onclick="openAddMenu()"
    class="fixed bottom-24 left-1/2 transform -translate-x-1/2
           bg-gradient-to-r from-purple-500 to-indigo-600
           text-white rounded-full w-16 h-16
           flex items-center justify-center
           shadow-2xl hover:shadow-purple-500/50
           transition-all duration-300 hover:scale-110
           z-50"
    style="display: none;"
    aria-label="×”×•×¡×£ ×¤×¨×™×˜ ×—×“×©"
  >
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/>
    </svg>
  </button>

  <!-- Bottom Sheet Menu Overlay -->
  <div id="add-menu-overlay" class="hidden fixed inset-0 bg-black/50 z-[60] transition-opacity" onclick="closeAddMenu()"></div>

  <!-- Bottom Sheet Menu -->
  <div id="add-menu" class="hidden fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl z-[70] transform translate-y-full transition-transform duration-300">
    <div class="p-6">
      <!-- Drag Handle -->
      <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6"></div>

      <!-- Title -->
      <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">
        ××” ×ª×¨×¦×” ×œ×”×•×¡×£?
      </h3>

      <!-- Options -->
      <div class="space-y-3">
        <button onclick="openAddModalFromSheet('event')" class="w-full bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 border-2 border-blue-500 rounded-2xl p-4 text-right transition-all hover:shadow-lg">
          <div class="flex items-center gap-4">
            <span class="text-3xl">ğŸ“…</span>
            <div class="flex-1">
              <div class="font-bold text-gray-800 text-lg">××™×¨×•×¢ ×—×“×©</div>
              <div class="text-sm text-gray-600">×¤×’×™×©×•×ª, ××™×¨×•×¢×™× ×•××•×¢×“×™×</div>
            </div>
          </div>
        </button>

        <button onclick="openAddModalFromSheet('reminder')" class="w-full bg-gradient-to-r from-amber-50 to-orange-50 hover:from-amber-100 hover:to-orange-100 border-2 border-amber-500 rounded-2xl p-4 text-right transition-all hover:shadow-lg">
          <div class="flex items-center gap-4">
            <span class="text-3xl">â°</span>
            <div class="flex-1">
              <div class="font-bold text-gray-800 text-lg">×ª×–×›×•×¨×ª ×—×“×©×”</div>
              <div class="text-sm text-gray-600">×ª×–×›×•×¨×•×ª ×œ×“×‘×¨×™× ×—×©×•×‘×™×</div>
            </div>
          </div>
        </button>

        <button onclick="openAddModalFromSheet('task')" class="w-full bg-gradient-to-r from-green-50 to-emerald-50 hover:from-green-100 hover:to-emerald-100 border-2 border-green-500 rounded-2xl p-4 text-right transition-all hover:shadow-lg">
          <div class="flex items-center gap-4">
            <span class="text-3xl">âœ…</span>
            <div class="flex-1">
              <div class="font-bold text-gray-800 text-lg">××©×™××” ×—×“×©×”</div>
              <div class="text-sm text-gray-600">×“×‘×¨×™× ×©×¦×¨×™×š ×œ×¢×©×•×ª</div>
            </div>
          </div>
        </button>
      </div>

      <!-- Cancel Button -->
      <button onclick="closeAddMenu()" class="w-full mt-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-2xl p-4 font-medium transition-all">
        ×‘×™×˜×•×œ
      </button>
    </div>
  </div>

  <script>
    const TOKEN = '{{TOKEN}}';
    let data = null;
    let expiryInterval = null;

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      // Set current date
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('he-IL', options);

      // Load data
      await loadDashboardData();
    });

    async function loadDashboardData() {
      try {
        const response = await fetch(`/api/dashboard/${TOKEN}`);

        if (!response.ok) {
          throw new Error('Failed to load dashboard data');
        }

        const result = await response.json();
        data = result.data;

        // Update stats with animations
        updateStatCard('stat-events', data.stats.totalEvents, 'progress-events', 100);
        updateStatCard('stat-today', data.stats.todayEvents, 'progress-today', 100);
        updateStatCard('stat-reminders', data.stats.totalReminders, 'progress-reminders', 100);
        updateStatCard('stat-upcoming', data.stats.upcomingReminders, 'progress-upcoming', 100);
        updateStatCard('stat-tasks', data.stats.activeTasks, 'progress-tasks', 100);

        // Calculate completion percentage
        const totalTasks = data.stats.activeTasks + data.stats.completedTasks;
        const completionPercentage = totalTasks > 0 ? (data.stats.completedTasks / totalTasks * 100) : 0;
        updateStatCard('stat-completed', data.stats.completedTasks, 'progress-completed', completionPercentage);

        // Animate stat cards
        setTimeout(() => {
          document.querySelectorAll('.stat-card').forEach((card, index) => {
            setTimeout(() => card.classList.add('loaded'), index * 100);
          });
        }, 100);

        // Start expiry timer
        startExpiryTimer(result.expiresIn);

        // Render events
        renderEvents(data.events);
        renderReminders(data.reminders);
        renderTasks(data.tasks);

        // Render Today's Overview
        renderTodayOverview();

        // Initialize week view (default)
        renderWeekView();

        // Show content
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showError('×œ× ×”×¦×œ×—× ×• ×œ×˜×¢×•×Ÿ ××ª ×”× ×ª×•× ×™×. ×× × × ×¡×” ×©×•×‘.');
      }
    }

    function startExpiryTimer(seconds) {
      const updateTimer = () => {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('expiryTimer').textContent =
          `×¤×’ ×ª×•×§×£ ×‘×¢×•×“ ${minutes}:${secs.toString().padStart(2, '0')}`;

        if (seconds <= 0) {
          clearInterval(expiryInterval);
          showError('×”×§×™×©×•×¨ ×¤×’ ×ª×•×§×¤×•. ×× × ×‘×§×© ×§×™×©×•×¨ ×—×“×© ××”×‘×•×˜.');
        }
        seconds--;
      };

      updateTimer();
      expiryInterval = setInterval(updateTimer, 1000);
    }

    function renderEvents(events) {
      const container = document.getElementById('events-list');

      if (events.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">ğŸ“­</div>
            <p class="text-gray-600 text-lg">××™×Ÿ ××™×¨×•×¢×™× ×§×¨×•×‘×™×</p>
          </div>
        `;
        return;
      }

      container.innerHTML = events.map((event, index) => {
        const start = new Date(event.startTsUtc);
        const isToday = isDateToday(start);
        const isPast = start < new Date();

        return `
          <div onclick="showEventModal(${index}, 'event')" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 md:p-6 border-r-4 border-blue-500 card-hover clickable-card ${isPast ? 'opacity-60' : ''}">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  ${isToday ? '<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold">×”×™×•×</span>' : ''}
                  ${isPast ? '<span class="bg-gray-400 text-white text-xs px-2 py-1 rounded-full">×¢×‘×¨</span>' : ''}
                  <span class="text-xs text-gray-500">×œ×—×¥ ×œ×¤×¨×˜×™× ××œ××™× ğŸ‘†</span>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">${escapeHtml(event.title)}</h3>
                <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                  <span class="flex items-center gap-1">
                    ğŸ“… ${formatDate(start)}
                  </span>
                  ${!event.isAllDay ? `<span class="flex items-center gap-1">ğŸ• ${formatTime(start)}</span>` : '<span class="flex items-center gap-1">â° ×›×œ ×”×™×•×</span>'}
                  ${event.location ? `<span class="flex items-center gap-1">ğŸ“ ${escapeHtml(event.location)}</span>` : ''}
                </div>
                ${event.notes ? `<p class="mt-3 text-gray-700 text-sm line-clamp-2">${escapeHtml(event.notes)}</p>` : ''}
              </div>
              <div class="text-3xl">${isPast ? 'âœ“' : 'ğŸ“…'}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderReminders(reminders) {
      const container = document.getElementById('reminders-list');

      if (reminders.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">ğŸ”•</div>
            <p class="text-gray-600 text-lg">××™×Ÿ ×ª×–×›×•×¨×•×ª ×¤×¢×™×œ×•×ª</p>
          </div>
        `;
        return;
      }

      container.innerHTML = reminders.map((reminder, index) => {
        const due = new Date(reminder.dueTsUtc);
        const isPast = due < new Date();
        const isUpcoming = !isPast && (due - new Date()) < 24 * 60 * 60 * 1000;

        return `
          <div onclick="showEventModal(${index}, 'reminder')" class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-4 md:p-6 border-r-4 border-amber-500 card-hover clickable-card ${reminder.status === 'cancelled' || isPast ? 'opacity-60' : ''}">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  ${isUpcoming ? '<span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full font-bold animate-pulse">×§×¨×•×‘!</span>' : ''}
                  ${reminder.status === 'cancelled' ? '<span class="bg-gray-400 text-white text-xs px-2 py-1 rounded-full">××‘×•×˜×œ</span>' : ''}
                  ${reminder.recurrence ? '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">×—×•×–×¨</span>' : ''}
                  <span class="text-xs text-gray-500">×œ×—×¥ ×œ×¤×¨×˜×™× ××œ××™× ğŸ‘†</span>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">${escapeHtml(reminder.title)}</h3>
                <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                  <span class="flex items-center gap-1">
                    ğŸ“… ${formatDate(due)}
                  </span>
                  <span class="flex items-center gap-1">
                    ğŸ• ${formatTime(due)}
                  </span>
                  ${reminder.recurrence ? `<span class="flex items-center gap-1">ğŸ”„ ${reminder.recurrence}</span>` : ''}
                </div>
              </div>
              <div class="text-3xl">â°</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTasks(tasks) {
      const container = document.getElementById('tasks-list');

      if (tasks.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <p class="text-gray-600 text-lg">×›×œ ×”××©×™××•×ª ×”×•×©×œ××•!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = tasks.map((task, index) => {
        const priorityClass = `priority-${task.priority}`;
        const priorityEmoji = {
          urgent: 'ğŸ”´',
          high: 'ğŸŸ ',
          normal: 'ğŸ”µ',
          low: 'ğŸŸ¢'
        }[task.priority] || 'ğŸ”µ';

        const isOverdue = task.dueTsUtc && new Date(task.dueTsUtc) < new Date();

        return `
          <div onclick="showEventModal(${index}, 'task')" class="bg-white rounded-xl p-4 md:p-6 ${priorityClass} shadow-md card-hover clickable-card">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-lg">${priorityEmoji}</span>
                  ${task.status === 'in_progress' ? '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">×‘×‘×™×¦×•×¢</span>' : ''}
                  ${isOverdue ? '<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full animate-pulse">×‘××™×—×•×¨!</span>' : ''}
                  <span class="text-xs text-gray-500">×œ×—×¥ ×œ×¤×¨×˜×™× ××œ××™× ğŸ‘†</span>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">${escapeHtml(task.title)}</h3>
                ${task.description ? `<p class="text-gray-600 text-sm mb-3 line-clamp-2">${escapeHtml(task.description)}</p>` : ''}
                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                  ${task.dueTsUtc ? `
                    <span class="flex items-center gap-1">
                      ğŸ“… ${formatDate(new Date(task.dueTsUtc))}
                    </span>
                  ` : ''}
                  <span class="flex items-center gap-1">
                    ğŸ·ï¸ ${getPriorityText(task.priority)}
                  </span>
                </div>
              </div>
              <div class="text-3xl">âœ…</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Calendar state
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDate = null;

    // Handle stat card clicks - Show summary drill-down
    function handleStatCardClick(cardType) {
      showStatSummaryModal(cardType);
    }

    function showStatSummaryModal(cardType) {
      const modal = document.getElementById('itemModal');
      const modalBody = document.getElementById('modalBody');

      let content = '';
      let items = [];
      let title = '';
      let icon = '';
      let headerColor = '';

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      switch(cardType) {
        case 'events':
          title = '×›×œ ×”××™×¨×•×¢×™×';
          icon = 'ğŸ“…';
          headerColor = 'from-blue-500 to-indigo-600';
          const now = new Date();
          items = data.events.map((event, index) => {
            const date = new Date(event.startTsUtc);
            const isToday = isDateToday(date);
            const isPast = date < now; // Check if event has already passed
            return {
              index,
              type: 'event',
              title: event.title,
              subtitle: `${formatDate(date)} â€¢ ${formatTime(date)}`,
              location: event.location,
              isToday,
              isPast
            };
          });
          break;

        case 'today':
          title = '×”××™×¨×•×¢×™× ×©×œ ×”×™×•×';
          icon = 'ğŸ—“ï¸';
          headerColor = 'from-purple-500 to-pink-600';
          const currentTime = new Date();
          const todayEvents = data.events.filter(e => {
            const eventDate = new Date(e.startTsUtc);
            return isDateToday(eventDate); // All events today (past and future)
          });
          const todayReminders = data.reminders.filter(r => {
            const reminderDate = new Date(r.dueTsUtc);
            return r.status !== 'cancelled' && isDateToday(reminderDate); // All reminders today
          });
          const todayTasks = data.tasks.filter(t => {
            const taskDate = t.dueTsUtc ? new Date(t.dueTsUtc) : null;
            return t.status !== 'completed' && taskDate && isDateToday(taskDate);
          });

          items = [
            ...todayEvents.map((event) => {
              const eventTime = new Date(event.startTsUtc);
              return {
                index: data.events.indexOf(event),
                type: 'event',
                title: event.title,
                subtitle: `${formatTime(eventTime)}${event.location ? ' â€¢ ' + event.location : ''}`,
                icon: 'ğŸ“…',
                isToday: true,
                isPast: eventTime < currentTime
              };
            }),
            ...todayReminders.map((reminder) => {
              const reminderTime = new Date(reminder.dueTsUtc);
              return {
                index: data.reminders.indexOf(reminder),
                type: 'reminder',
                title: reminder.title,
                subtitle: formatTime(reminderTime),
                icon: 'â°',
                isToday: true,
                isPast: reminderTime < currentTime
              };
            }),
            ...todayTasks.map((task) => ({
              index: data.tasks.indexOf(task),
              type: 'task',
              title: task.title,
              subtitle: getPriorityText(task.priority),
              icon: 'âœ…',
              isToday: true,
              isPast: false
            }))
          ];
          break;

        case 'reminders':
        case 'upcoming':
          title = cardType === 'upcoming' ? '×ª×–×›×•×¨×•×ª ×§×¨×•×‘×•×ª' : '×›×œ ×”×ª×–×›×•×¨×•×ª';
          icon = 'â°';
          headerColor = 'from-amber-500 to-orange-600';
          const currentTimeForReminders = new Date();
          const reminders = data.reminders.filter(r => r.status !== 'cancelled');
          items = (cardType === 'upcoming'
            ? reminders.filter(r => {
                const dueDate = new Date(r.dueTsUtc);
                const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                return daysUntil <= 7 && daysUntil >= 0;
              })
            : reminders
          ).map((reminder) => {
            const date = new Date(reminder.dueTsUtc);
            return {
              index: data.reminders.indexOf(reminder),
              type: 'reminder',
              title: reminder.title,
              subtitle: `${formatDate(date)} â€¢ ${formatTime(date)}`,
              recurrence: reminder.recurrence,
              isToday: isDateToday(date),
              isPast: date < currentTimeForReminders
            };
          });
          break;

        case 'tasks':
          title = '××©×™××•×ª ×¤×¢×™×œ×•×ª';
          icon = 'âœ…';
          headerColor = 'from-green-500 to-emerald-600';
          items = data.tasks.filter(t => t.status !== 'completed').map((task, index) => {
            const hasDue = task.dueTsUtc;
            const date = hasDue ? new Date(task.dueTsUtc) : null;
            return {
              index,
              type: 'task',
              title: task.title,
              subtitle: hasDue ? `${formatDate(date)} â€¢ ${getPriorityText(task.priority)}` : getPriorityText(task.priority),
              priority: task.priority,
              isToday: hasDue && isDateToday(date)
            };
          });
          break;

        case 'completed':
          title = '××©×™××•×ª ×©×”×•×©×œ××•';
          icon = 'ğŸ¯';
          headerColor = 'from-teal-500 to-cyan-600';
          items = data.tasks.filter(t => t.status === 'completed').map((task, index) => {
            return {
              index,
              type: 'task',
              title: task.title,
              subtitle: task.description || '×”×•×©×œ×',
              completed: true
            };
          });
          break;
      }

      // Build modal content
      content = `
        <div class="gradient-bg bg-gradient-to-br ${headerColor} p-8 shadow-lg relative overflow-hidden">
          <!-- Decorative pattern overlay -->
          <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(circle at 2px 2px, white 1px, transparent 0); background-size: 24px 24px;"></div>

          <div class="relative z-10">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                <span class="text-4xl drop-shadow-lg">${icon}</span>
                <span class="drop-shadow-md">${title}</span>
              </h2>
              <button onclick="closeModal()" class="text-white/90 hover:text-white hover:bg-white/20 hover:rotate-90 rounded-full p-2.5 transition-all duration-300 active:scale-90">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="flex items-baseline gap-3 text-white">
              <span class="font-bold text-5xl drop-shadow-md">${items.length}</span>
              <span class="text-xl opacity-90">×¤×¨×™×˜×™×</span>
            </div>
          </div>
        </div>
        <div class="p-6 md:p-8 max-h-[55vh] overflow-y-auto" style="scrollbar-gutter: stable;">`;

      if (items.length === 0) {
        content += `
          <div class="text-center py-16 animate-fadeIn">
            <div class="text-7xl mb-6 opacity-40">${icon}</div>
            <p class="text-gray-500 text-xl font-medium">××™×Ÿ ×¤×¨×™×˜×™× ×œ×”×¦×’×”</p>
            <p class="text-gray-400 text-sm mt-2">×œ× × ××¦××• ×¤×¨×™×˜×™× ×¢×‘×•×¨ ×§×˜×’×•×¨×™×” ×–×•</p>
          </div>`;
      } else {
        content += '<div class="space-y-3">';
        items.forEach((item, idx) => {
          let badge = '';

          if (item.isPast) {
            // Past items get "×¢×‘×¨" badge (higher priority)
            badge = '<span class="bg-gray-300 text-gray-700 text-xs px-3 py-1.5 rounded-full font-medium">×¢×‘×¨</span>';
          } else if (item.isToday) {
            // Today items that haven't passed yet get "×”×™×•×" badge
            badge = '<span class="bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs px-3 py-1.5 rounded-full font-bold shadow-sm animate-pulse">×”×™×•×</span>';
          }

          let cardColor = 'bg-gray-50';
          let borderColor = 'border-gray-300';
          let iconEmoji = 'ğŸ“„';
          let hoverEffect = 'hover:shadow-xl hover:scale-[1.02] hover:-translate-y-1';

          if (item.type === 'event') {
            cardColor = 'bg-gradient-to-br from-blue-50 via-indigo-50 to-blue-50';
            borderColor = 'border-blue-400';
            iconEmoji = 'ğŸ“…';
          } else if (item.type === 'reminder') {
            cardColor = 'bg-gradient-to-br from-amber-50 via-orange-50 to-amber-50';
            borderColor = 'border-amber-400';
            iconEmoji = 'â°';
          } else if (item.type === 'task') {
            if (item.completed) {
              cardColor = 'bg-gradient-to-br from-teal-50 via-cyan-50 to-teal-50';
              borderColor = 'border-teal-400';
              iconEmoji = 'âœ“';
            } else {
              cardColor = 'bg-gradient-to-br from-green-50 via-emerald-50 to-green-50';
              borderColor = 'border-green-400';
              iconEmoji = 'âœ…';
            }
          }

          content += `
            <div onclick="showEventModal(${item.index}, '${item.type}')"
                 class="${cardColor} rounded-2xl p-5 border-r-4 ${borderColor} cursor-pointer ${hoverEffect} transition-all duration-300 active:scale-95 shadow-sm group"
                 style="animation: slideInRight 0.4s ease-out ${idx * 0.05}s both;">
              <div class="flex items-start justify-between gap-4">
                <div class="flex items-start gap-3 flex-1 min-w-0">
                  <div class="text-2xl flex-shrink-0 group-hover:scale-110 transition-transform duration-300">${iconEmoji}</div>
                  <div class="flex-1 min-w-0">
                    <div class="font-bold text-gray-900 mb-1.5 text-base group-hover:text-gray-700 transition-colors line-clamp-2">${escapeHtml(item.title)}</div>
                    <div class="text-sm text-gray-600 mb-1">${item.subtitle}</div>
                    ${item.location ? `<div class="text-xs text-gray-500 mt-2 flex items-center gap-1.5">
                      <span class="opacity-60">ğŸ“</span>
                      <span class="truncate">${escapeHtml(item.location)}</span>
                    </div>` : ''}
                    ${item.recurrence ? `<div class="text-xs text-gray-500 mt-2 flex items-center gap-1.5">
                      <span class="opacity-60">ğŸ”„</span>
                      <span>${item.recurrence}</span>
                    </div>` : ''}
                  </div>
                </div>
                <div class="flex-shrink-0">
                  ${badge}
                </div>
              </div>
            </div>`;
        });
        content += '</div>';
      }

      // Add CSS animations
      const style = document.createElement('style');
      if (!document.getElementById('drill-down-animations')) {
        style.id = 'drill-down-animations';
        style.textContent = `
          @keyframes slideInRight {
            from {
              opacity: 0;
              transform: translateX(20px);
            }
            to {
              opacity: 1;
              transform: translateX(0);
            }
          }
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
          }
          .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
          }
        `;
        document.head.appendChild(style);
      }

      content += `
          <div class="mt-8 pt-6 border-t border-gray-200 flex justify-center">
            <button onclick="showStatDetailView('${cardType}')"
                    class="group relative px-8 py-4 bg-gradient-to-r ${headerColor} text-white rounded-2xl font-bold hover:shadow-2xl transition-all duration-300 active:scale-95 overflow-hidden">
              <span class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition-opacity duration-300"></span>
              <span class="relative flex items-center gap-2">
                <span>×¢×‘×•×¨ ×œ×ª×¦×•×’×” ××¤×•×¨×˜×ª</span>
                <svg class="w-5 h-5 group-hover:translate-x-[-4px] transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l-5 5 5 5"></path>
                </svg>
              </span>
            </button>
          </div>
        </div>`;

      modalBody.innerHTML = content;
      modal.classList.add('active');
    }

    function showStatDetailView(cardType) {
      closeModal();
      // Navigate to detailed view based on card type
      const detailActions = {
        'events': () => showTab('agenda', 'event'),
        'today': () => {
          const todayPanel = document.getElementById('today-overview');
          if (todayPanel) {
            todayPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        },
        'reminders': () => showTab('agenda', 'reminder'),
        'upcoming': () => showTab('agenda', 'reminder'),
        'tasks': () => showTab('agenda', 'task'),
        'completed': () => showTab('tasks')
      };

      if (detailActions[cardType]) {
        detailActions[cardType]();
      }
    }

    async function showPastEventsModal() {
      const modal = document.getElementById('itemModal');
      const modalBody = document.getElementById('modalBody');

      // Show loading state
      modalBody.innerHTML = `
        <div class="p-16 text-center">
          <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-gray-300 border-t-purple-600 mb-4"></div>
          <p class="text-gray-600 text-lg">×˜×•×¢×Ÿ ××™×¨×•×¢×™ ×¢×‘×¨...</p>
        </div>`;
      modal.classList.add('active');

      try {
        // Fetch past events with stats
        const response = await fetch(`/api/dashboard/${TOKEN}/past-events?includeStats=true&groupBy=month&limit=50`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Failed to load past events');
        }

        const { events, stats } = result.data;

        // Build modal content with summary
        let content = `
          <div class="gradient-bg bg-gradient-to-br from-purple-500 to-indigo-600 p-8 shadow-lg relative overflow-hidden">
            <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(circle at 2px 2px, white 1px, transparent 0); background-size: 24px 24px;"></div>

            <div class="relative z-10">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                  <span class="text-4xl drop-shadow-lg">ğŸ•</span>
                  <span class="drop-shadow-md">××™×¨×•×¢×™ ×”×¢×‘×¨</span>
                </h2>
                <button onclick="closeModal()" class="text-white/90 hover:text-white hover:bg-white/20 hover:rotate-90 rounded-full p-2.5 transition-all duration-300 active:scale-90">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>

              <!-- Stats Summary -->
              <div class="grid grid-cols-2 gap-4 mt-6">
                <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                  <div class="text-4xl font-bold text-white">${stats?.totalCount || 0}</div>
                  <div class="text-white/80 text-sm mt-1">×¡×”"×› ××™×¨×•×¢×™×</div>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                  <div class="text-4xl font-bold text-white">${stats?.topLocations?.length || 0}</div>
                  <div class="text-white/80 text-sm mt-1">××™×§×•××™×</div>
                </div>
              </div>
            </div>
          </div>

          <div class="p-6 md:p-8 max-h-[55vh] overflow-y-auto">`;

        if (events && events.length > 0) {
          // Show recent past events (limit to 10 for popup)
          content += '<div class="mb-6"><h3 class="text-lg font-bold text-gray-800 mb-3">××™×¨×•×¢×™× ××—×¨×•× ×™×</h3><div class="space-y-3">';

          events.slice(0, 10).forEach((event, idx) => {
            const eventDate = new Date(event.startTsUtc);
            const dateStr = formatDate(eventDate);
            const timeStr = formatTime(eventDate);

            content += `
              <div class="bg-gradient-to-br from-blue-50 via-indigo-50 to-blue-50 rounded-2xl p-5 border-r-4 border-blue-400 shadow-sm hover:shadow-lg transition-all duration-300"
                   style="animation: slideInRight 0.4s ease-out ${idx * 0.05}s both;">
                <div class="flex items-start gap-3">
                  <div class="text-2xl flex-shrink-0">ğŸ“…</div>
                  <div class="flex-1 min-w-0">
                    <div class="font-bold text-gray-900 mb-1.5 text-base">${escapeHtml(event.title)}</div>
                    <div class="text-sm text-gray-600">${dateStr} â€¢ ${timeStr}</div>
                    ${event.location ? `<div class="text-xs text-gray-500 mt-2 flex items-center gap-1.5">
                      <span class="opacity-60">ğŸ“</span>
                      <span class="truncate">${escapeHtml(event.location)}</span>
                    </div>` : ''}
                  </div>
                </div>
              </div>`;
          });

          content += '</div></div>';

          // Show top locations if available
          if (stats?.topLocations && stats.topLocations.length > 0) {
            content += '<div class="mb-6"><h3 class="text-lg font-bold text-gray-800 mb-3">××™×§×•××™× ×¤×•×¤×•×œ×¨×™×™×</h3><div class="grid grid-cols-2 gap-3">';

            stats.topLocations.slice(0, 6).forEach((loc) => {
              content += `
                <div class="bg-white rounded-lg p-3 border border-gray-200 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="text-xl">ğŸ“</span>
                    <span class="font-medium text-gray-800 text-sm">${escapeHtml(loc.location)}</span>
                  </div>
                  <span class="text-lg font-bold text-purple-600">${loc.count}</span>
                </div>`;
            });

            content += '</div></div>';
          }
        } else {
          content += `
            <div class="text-center py-16">
              <div class="text-7xl mb-6 opacity-40">ğŸ•</div>
              <p class="text-gray-500 text-xl font-medium">××™×Ÿ ××™×¨×•×¢×™ ×¢×‘×¨</p>
              <p class="text-gray-400 text-sm mt-2">×œ× × ××¦××• ××™×¨×•×¢×™× ×©×”×ª×§×™×™××• ×‘×¢×‘×¨</p>
            </div>`;
        }

        // Add button to detailed report
        content += `
            <div class="mt-8 pt-6 border-t border-gray-200 flex justify-center">
              <a href="/past-events-report/${TOKEN}" target="_blank"
                 class="group relative px-8 py-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-2xl font-bold hover:shadow-2xl transition-all duration-300 active:scale-95 overflow-hidden inline-block">
                <span class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition-opacity duration-300"></span>
                <span class="relative flex items-center gap-2">
                  <span>×¢×‘×•×¨ ×œ×“×•×— ×”××¤×•×¨×˜</span>
                  <svg class="w-5 h-5 group-hover:translate-x-[-4px] transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l-5 5 5 5"></path>
                  </svg>
                </span>
              </a>
            </div>
          </div>`;

        modalBody.innerHTML = content;
      } catch (error) {
        console.error('Failed to load past events:', error);
        modalBody.innerHTML = `
          <div class="p-16 text-center">
            <div class="text-7xl mb-6 opacity-40">âš ï¸</div>
            <p class="text-gray-500 text-xl font-medium">×©×’×™××” ×‘×˜×¢×™× ×ª ××™×¨×•×¢×™ ×”×¢×‘×¨</p>
            <p class="text-gray-400 text-sm mt-2">${error.message}</p>
            <button onclick="closeModal()" class="mt-6 px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-xl font-medium transition-all">
              ×¡×’×•×¨
            </button>
          </div>`;
      }
    }

    function showTab(tab, priorityFilter = null) {
      // Hide all sections
      const sections = ['week', 'month', 'agenda', 'calendar', 'events', 'reminders', 'tasks'];
      sections.forEach(section => {
        const el = document.getElementById(`section-${section}`);
        if (el) el.classList.add('hidden');
      });

      // Reset all tab buttons
      const tabs = ['week', 'month', 'agenda', 'calendar', 'events', 'reminders', 'tasks'];
      tabs.forEach(t => {
        const el = document.getElementById(`tab-${t}`);
        if (el) el.className = 'px-6 py-3 rounded-xl font-medium transition-all text-gray-700 hover:bg-gray-100';
      });

      // Show selected section and activate tab
      const section = document.getElementById(`section-${tab}`);
      const tabBtn = document.getElementById(`tab-${tab}`);
      if (section) section.classList.remove('hidden');
      if (tabBtn) tabBtn.className = 'px-6 py-3 rounded-xl font-medium transition-all bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-lg';

      // Render specific views
      if (tab === 'week') renderWeekView();
      if (tab === 'month') renderMonthView();
      if (tab === 'agenda') renderAgendaView(priorityFilter);
      if (tab === 'calendar') renderCalendar();
    }

    function showError(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.add('hidden');
      document.getElementById('error-message').textContent = message;
      document.getElementById('error').classList.remove('hidden');
    }

    function formatDate(date) {
      return date.toLocaleDateString('he-IL', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function formatTime(date) {
      return date.toLocaleTimeString('he-IL', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function isDateToday(date) {
      const today = new Date();
      return date.getDate() === today.getDate() &&
             date.getMonth() === today.getMonth() &&
             date.getFullYear() === today.getFullYear();
    }

    function getPriorityText(priority) {
      const map = {
        urgent: '×“×—×•×£',
        high: '×’×‘×•×”',
        normal: '×¨×’×™×œ',
        low: '× ××•×š'
      };
      return map[priority] || '×¨×’×™×œ';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Calendar functions
    function initializeCalendar() {
      currentMonth = new Date().getMonth();
      currentYear = new Date().getFullYear();
      renderCalendar();
    }

    function renderCalendar() {
      const monthNames = [
        '×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
        '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'
      ];

      // Update month/year display
      document.getElementById('calendar-month-year').textContent =
        `${monthNames[currentMonth]} ${currentYear}`;

      // Get first day of month and number of days
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();

      // Calculate previous month's days to show
      const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
      const prevMonthDays = startingDayOfWeek;

      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';

      let dayCounter = 1;
      let nextMonthDay = 1;

      // Create 6 weeks (42 days total)
      for (let i = 0; i < 42; i++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day bg-white rounded-lg p-2 border border-gray-200 cursor-pointer';

        let currentDay, currentMonth_local, currentYear_local;
        let isCurrentMonth = false;
        let isToday = false;

        if (i < prevMonthDays) {
          // Previous month
          currentDay = prevMonthLastDay - prevMonthDays + i + 1;
          currentMonth_local = currentMonth === 0 ? 11 : currentMonth - 1;
          currentYear_local = currentMonth === 0 ? currentYear - 1 : currentYear;
          dayCell.classList.add('opacity-40');
        } else if (dayCounter <= daysInMonth) {
          // Current month
          currentDay = dayCounter;
          currentMonth_local = currentMonth;
          currentYear_local = currentYear;
          isCurrentMonth = true;
          dayCounter++;

          // Check if today
          const today = new Date();
          if (currentDay === today.getDate() &&
              currentMonth === today.getMonth() &&
              currentYear === today.getFullYear()) {
            isToday = true;
            dayCell.classList.add('calendar-today');
          }
        } else {
          // Next month
          currentDay = nextMonthDay;
          currentMonth_local = currentMonth === 11 ? 0 : currentMonth + 1;
          currentYear_local = currentMonth === 11 ? currentYear + 1 : currentYear;
          nextMonthDay++;
          dayCell.classList.add('opacity-40');
        }

        // Create date string
        const dateStr = `${currentYear_local}-${String(currentMonth_local + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;

        // Day number
        const dayNumber = document.createElement('div');
        dayNumber.className = 'font-bold text-gray-700 mb-1 text-sm';
        dayNumber.textContent = currentDay;
        dayCell.appendChild(dayNumber);

        // Get items for this day
        const dayItems = getItemsForDate(dateStr);

        // Show dots for items
        if (dayItems.events.length + dayItems.reminders.length + dayItems.tasks.length > 0) {
          const dotsContainer = document.createElement('div');
          dotsContainer.className = 'flex gap-1 mb-1 flex-wrap';

          dayItems.events.slice(0, 3).forEach(() => {
            const dot = document.createElement('div');
            dot.className = 'event-dot bg-blue-500';
            dotsContainer.appendChild(dot);
          });

          dayItems.reminders.slice(0, 3).forEach(() => {
            const dot = document.createElement('div');
            dot.className = 'event-dot bg-amber-500';
            dotsContainer.appendChild(dot);
          });

          dayItems.tasks.slice(0, 3).forEach(() => {
            const dot = document.createElement('div');
            dot.className = 'event-dot bg-green-500';
            dotsContainer.appendChild(dot);
          });

          dayCell.appendChild(dotsContainer);

          // Show first few items as mini labels (only for current month)
          if (isCurrentMonth) {
            const itemsPreview = document.createElement('div');
            itemsPreview.className = 'space-y-1';

            [...dayItems.events.slice(0, 2)].forEach(event => {
              const item = document.createElement('div');
              item.className = 'event-item bg-blue-100 text-blue-800';
              item.textContent = event.title;
              item.title = event.title;
              item.onclick = (e) => {
                e.stopPropagation();
                showEventModal(data.events.indexOf(event), 'event');
              };
              itemsPreview.appendChild(item);
            });

            [...dayItems.reminders.slice(0, 1)].forEach(reminder => {
              const item = document.createElement('div');
              item.className = 'event-item bg-amber-100 text-amber-800';
              item.textContent = reminder.title;
              item.title = reminder.title;
              item.onclick = (e) => {
                e.stopPropagation();
                showEventModal(data.reminders.indexOf(reminder), 'reminder');
              };
              itemsPreview.appendChild(item);
            });

            dayCell.appendChild(itemsPreview);
          }
        }

        // Click handler
        dayCell.onclick = () => showDayDetails(dateStr, currentDay, currentMonth_local, currentYear_local);

        grid.appendChild(dayCell);
      }
    }

    function getItemsForDate(dateStr) {
      const result = {
        events: [],
        reminders: [],
        tasks: []
      };

      if (!data) return result;

      // Check events - store both event and original index
      data.events.forEach((event, index) => {
        const eventDate = new Date(event.startTsUtc);
        const eventDateStr = `${eventDate.getFullYear()}-${String(eventDate.getMonth() + 1).padStart(2, '0')}-${String(eventDate.getDate()).padStart(2, '0')}`;
        if (eventDateStr === dateStr) {
          result.events.push({ ...event, originalIndex: index });
        }
      });

      // Check reminders - store both reminder and original index
      data.reminders.forEach((reminder, index) => {
        const reminderDate = new Date(reminder.dueTsUtc);
        const reminderDateStr = `${reminderDate.getFullYear()}-${String(reminderDate.getMonth() + 1).padStart(2, '0')}-${String(reminderDate.getDate()).padStart(2, '0')}`;
        if (reminderDateStr === dateStr && reminder.status !== 'cancelled') {
          result.reminders.push({ ...reminder, originalIndex: index });
        }
      });

      // Check tasks - store both task and original index
      data.tasks.forEach((task, index) => {
        if (task.dueTsUtc) {
          const taskDate = new Date(task.dueTsUtc);
          const taskDateStr = `${taskDate.getFullYear()}-${String(taskDate.getMonth() + 1).padStart(2, '0')}-${String(taskDate.getDate()).padStart(2, '0')}`;
          if (taskDateStr === dateStr) {
            result.tasks.push({ ...task, originalIndex: index });
          }
        }
      });

      return result;
    }

    function showDayDetails(dateStr, day, month, year) {
      const monthNames = [
        '×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
        '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'
      ];

      const dayItems = getItemsForDate(dateStr);
      const total = dayItems.events.length + dayItems.reminders.length + dayItems.tasks.length;

      // If no items for this day, don't show modal
      if (total === 0) {
        return;
      }

      const modal = document.getElementById('itemModal');
      const modalBody = document.getElementById('modalBody');

      // Build modal content
      let modalContent = `
        <div class="relative">
          <!-- Header with decorative gradient -->
          <div class="relative bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 text-white rounded-t-3xl p-8 overflow-hidden">
            <!-- Decorative pattern overlay -->
            <div class="absolute inset-0 opacity-10">
              <div class="absolute inset-0" style="background-image: radial-gradient(circle, white 1px, transparent 1px); background-size: 20px 20px;"></div>
            </div>

            <!-- Close button -->
            <button
              onclick="closeModal()"
              class="absolute top-6 left-6 w-10 h-10 bg-white/20 backdrop-blur-sm hover:bg-white/30 rounded-full flex items-center justify-center transition-all hover:scale-110 z-10"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>

            <!-- Title -->
            <div class="relative text-center">
              <div class="text-5xl mb-3">ğŸ“…</div>
              <h2 class="text-2xl font-bold mb-1">${day} ×‘${monthNames[month]} ${year}</h2>
              <p class="text-white/90 text-sm font-medium">${total} ×¤×¨×™×˜×™×</p>
            </div>
          </div>

          <!-- Body with items -->
          <div class="bg-gradient-to-b from-gray-50 to-white p-6 rounded-b-3xl max-h-[60vh] overflow-y-auto">
            <div class="space-y-3">
      `;

      // Show events
      dayItems.events.forEach((event, idx) => {
        const now = new Date();
        const eventDate = new Date(event.startTsUtc);
        const isPast = eventDate < now;
        const isToday = isDateToday(eventDate);

        let badge = '';
        if (isPast) {
          badge = '<span class="bg-gray-300 text-gray-700 text-xs px-3 py-1.5 rounded-full font-medium">×¢×‘×¨</span>';
        } else if (isToday) {
          badge = '<span class="bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs px-3 py-1.5 rounded-full font-bold shadow-sm animate-pulse">×”×™×•×</span>';
        }

        modalContent += `
          <div
            onclick="showEventModal(${event.originalIndex}, 'event'); closeModal();"
            class="group bg-white hover:bg-blue-50 border-2 border-blue-200 hover:border-blue-400 rounded-2xl p-4 cursor-pointer transition-all duration-300 hover:shadow-xl hover:scale-[1.02] transform"
            style="animation: slideInRight 0.3s ease-out ${idx * 0.05}s both;"
          >
            <div class="flex items-start gap-3">
              <div class="text-3xl group-hover:scale-110 transition-transform">ğŸ“…</div>
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2 mb-2">
                  <h3 class="font-bold text-gray-900 text-lg leading-tight">${escapeHtml(event.title)}</h3>
                  ${badge}
                </div>
                <div class="space-y-1 text-sm text-gray-600">
                  <div class="flex items-center gap-2">
                    ${event.isAllDay ? 'â° ×›×œ ×”×™×•×' : `ğŸ• ${formatTime(new Date(event.startTsUtc))}`}
                  </div>
                  ${event.location ? `
                    <div class="flex items-center gap-2">
                      <span>ğŸ“</span>
                      <span class="truncate">${escapeHtml(event.location)}</span>
                    </div>
                  ` : ''}
                </div>
              </div>
              <svg class="w-5 h-5 text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </div>
          </div>
        `;
      });

      // Show reminders
      dayItems.reminders.forEach((reminder, idx) => {
        const now = new Date();
        const reminderDate = new Date(reminder.dueTsUtc);
        const isPast = reminderDate < now;
        const isToday = isDateToday(reminderDate);

        let badge = '';
        if (isPast) {
          badge = '<span class="bg-gray-300 text-gray-700 text-xs px-3 py-1.5 rounded-full font-medium">×¢×‘×¨</span>';
        } else if (isToday) {
          badge = '<span class="bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs px-3 py-1.5 rounded-full font-bold shadow-sm animate-pulse">×”×™×•×</span>';
        }

        modalContent += `
          <div
            onclick="showEventModal(${reminder.originalIndex}, 'reminder'); closeModal();"
            class="group bg-white hover:bg-amber-50 border-2 border-amber-200 hover:border-amber-400 rounded-2xl p-4 cursor-pointer transition-all duration-300 hover:shadow-xl hover:scale-[1.02] transform"
            style="animation: slideInRight 0.3s ease-out ${(dayItems.events.length + idx) * 0.05}s both;"
          >
            <div class="flex items-start gap-3">
              <div class="text-3xl group-hover:scale-110 transition-transform">â°</div>
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2 mb-2">
                  <h3 class="font-bold text-gray-900 text-lg leading-tight">${escapeHtml(reminder.title)}</h3>
                  ${badge}
                </div>
                <div class="space-y-1 text-sm text-gray-600">
                  <div class="flex items-center gap-2">
                    <span>ğŸ•</span>
                    <span>${formatTime(new Date(reminder.dueTsUtc))}</span>
                  </div>
                  ${reminder.recurrence ? `
                    <div class="flex items-center gap-2">
                      <span>ğŸ”„</span>
                      <span>${reminder.recurrence}</span>
                    </div>
                  ` : ''}
                </div>
              </div>
              <svg class="w-5 h-5 text-amber-400 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </div>
          </div>
        `;
      });

      // Show tasks
      dayItems.tasks.forEach((task, idx) => {
        const priorityEmoji = {
          urgent: 'ğŸ”´',
          high: 'ğŸŸ ',
          normal: 'ğŸ”µ',
          low: 'ğŸŸ¢'
        }[task.priority] || 'ğŸ”µ';

        const now = new Date();
        const taskDate = new Date(task.dueTsUtc);
        const isPast = taskDate < now;
        const isToday = isDateToday(taskDate);

        let badge = '';
        if (isPast) {
          badge = '<span class="bg-gray-300 text-gray-700 text-xs px-3 py-1.5 rounded-full font-medium">×¢×‘×¨</span>';
        } else if (isToday) {
          badge = '<span class="bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs px-3 py-1.5 rounded-full font-bold shadow-sm animate-pulse">×”×™×•×</span>';
        }

        modalContent += `
          <div
            onclick="showEventModal(${task.originalIndex}, 'task'); closeModal();"
            class="group bg-white hover:bg-green-50 border-2 border-green-200 hover:border-green-400 rounded-2xl p-4 cursor-pointer transition-all duration-300 hover:shadow-xl hover:scale-[1.02] transform"
            style="animation: slideInRight 0.3s ease-out ${(dayItems.events.length + dayItems.reminders.length + idx) * 0.05}s both;"
          >
            <div class="flex items-start gap-3">
              <div class="text-3xl group-hover:scale-110 transition-transform">âœ…</div>
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2 mb-2">
                  <h3 class="font-bold text-gray-900 text-lg leading-tight">
                    ${priorityEmoji} ${escapeHtml(task.title)}
                  </h3>
                  ${badge}
                </div>
                ${task.description ? `
                  <p class="text-sm text-gray-600 mb-2 line-clamp-2">${escapeHtml(task.description)}</p>
                ` : ''}
                <div class="text-xs text-gray-500">
                  ğŸ·ï¸ ${getPriorityText(task.priority)}
                </div>
              </div>
              <svg class="w-5 h-5 text-green-400 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </div>
          </div>
        `;
      });

      modalContent += `
            </div>
          </div>
        </div>
      `;

      modalBody.innerHTML = modalContent;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    }

    function goToToday() {
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      renderCalendar();
    }

    // Week view state and functions
    let currentWeekStart = new Date();
    currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());  // Start of week (Sunday)

    function changeWeek(delta) {
      currentWeekStart.setDate(currentWeekStart.getDate() + (delta * 7));
      renderWeekView();
    }

    function goToThisWeek() {
      currentWeekStart = new Date();
      currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
      renderWeekView();
    }

    function renderWeekView() {
      const weekEnd = new Date(currentWeekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);

      // Update week range display
      const rangeText = `${currentWeekStart.getDate()}/${currentWeekStart.getMonth()+1} - ${weekEnd.getDate()}/${weekEnd.getMonth()+1}`;
      document.getElementById('week-range').textContent = rangeText;

      const container = document.getElementById('week-view-content');
      const today = new Date();
      const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];

      // Build 7-day grid with time slots (24 hours)
      const timeSlots = [];
      for (let hour = 0; hour <= 23; hour++) {
        timeSlots.push(String(hour).padStart(2, '0') + ':00');
      }

      let html = '<div class="week-grid">';

      // Header row
      html += '<div class="time-slot"></div>'; // Empty corner
      for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(date.getDate() + i);
        const isToday = date.toDateString() === today.toDateString();
        html += `<div class="day-header ${isToday ? 'today' : ''}">
          <div style="font-weight: 600;">${dayNames[i]}</div>
          <div style="font-size: 0.75rem; font-weight: 400; margin-top: 2px;">${date.getDate()}/${date.getMonth()+1}</div>
        </div>`;
      }

      // Time slot rows
      timeSlots.forEach((time, rowIndex) => {
        html += `<div class="time-slot">${time}</div>`;

        for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
          const date = new Date(currentWeekStart);
          date.setDate(date.getDate() + dayIndex);
          const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;

          html += `<div class="day-column" id="day-${dayIndex}-${rowIndex}">`;

          // Add events/reminders for this day/time
          const hour = parseInt(time.split(':')[0]);

          // Add events for this hour
          data.events.forEach((event, eventIdx) => {
            const eventStart = new Date(event.startTsUtc);
            const eventDateStr = `${eventStart.getFullYear()}-${String(eventStart.getMonth()+1).padStart(2,'0')}-${String(eventStart.getDate()).padStart(2,'0')}`;
            const eventHour = eventStart.getHours();

            if (eventDateStr === dateStr && eventHour === hour) {
              const top = ((eventStart.getMinutes() / 60) * 56);
              const eventEnd = event.endTsUtc ? new Date(event.endTsUtc) : new Date(eventStart.getTime() + 60*60*1000);
              const durationMinutes = Math.max(30, (eventEnd - eventStart) / (1000 * 60));
              const height = Math.min(56, (durationMinutes / 60) * 56);

              html += `<div class="event-block event-block-event" style="top: ${top}px; height: ${height}px;" onclick="showEventModal(${eventIdx}, 'event')">
                ${escapeHtml(event.title.substring(0, 25))}${event.title.length > 25 ? '...' : ''}
              </div>`;
            }
          });

          // Add reminders for this hour
          data.reminders.filter(r => r.status !== 'cancelled').forEach((reminder, reminderIdx) => {
            const reminderTime = new Date(reminder.dueTsUtc);
            const reminderDateStr = `${reminderTime.getFullYear()}-${String(reminderTime.getMonth()+1).padStart(2,'0')}-${String(reminderTime.getDate()).padStart(2,'0')}`;
            const reminderHour = reminderTime.getHours();

            if (reminderDateStr === dateStr && reminderHour === hour) {
              const top = ((reminderTime.getMinutes() / 60) * 56);
              const originalReminderIdx = data.reminders.indexOf(reminder);

              html += `<div class="event-block event-block-reminder" style="top: ${top}px; height: 28px;" onclick="showEventModal(${originalReminderIdx}, 'reminder')">
                â° ${escapeHtml(reminder.title.substring(0, 20))}${reminder.title.length > 20 ? '...' : ''}
              </div>`;
            }
          });

          html += '</div>';
        }
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderMonthView();
    }

    function goToThisMonth() {
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      renderMonthView();
    }

    function renderMonthView() {
      const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
      document.getElementById('month-name').textContent = `${monthNames[currentMonth]} ${currentYear}`;

      const container = document.getElementById('month-view-content');
      const today = new Date();
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();

      const dayNames = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];

      let html = '<div class="mb-4 grid grid-cols-7 gap-2 text-center text-sm font-bold text-gray-700">';
      dayNames.forEach(day => html += `<div>${day}</div>`);
      html += '</div><div class="compact-month">';

      // Empty cells before month starts
      for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="compact-day opacity-30"></div>';
      }

      // Days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const isToday = date.toDateString() === today.toDateString();
        const dayItems = getItemsForDate(dateStr);
        const totalItems = dayItems.events.length + dayItems.reminders.length + dayItems.tasks.length;

        html += `<div class="compact-day ${isToday ? 'today' : ''} ${totalItems > 0 ? 'has-events' : ''}" onclick="showDayDetails('${dateStr}', ${day}, ${currentMonth}, ${currentYear})">
          <div class="text-lg">${day}</div>
          ${totalItems > 0 ? `<div class="event-count-badge">${totalItems}</div>` : ''}
        </div>`;
      }

      html += '</div>';
      container.innerHTML = html;
    }

    function renderAgendaView(priorityFilter = null) {
      const container = document.getElementById('agenda-list');
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Combine and sort all items by date
      const allItems = [];

      data.events.forEach((event, index) => {
        allItems.push({
          type: 'event',
          index: index,
          date: new Date(event.startTsUtc),
          data: event
        });
      });

      data.reminders.filter(r => r.status !== 'cancelled').forEach((reminder, index) => {
        allItems.push({
          type: 'reminder',
          index: index,
          date: new Date(reminder.dueTsUtc),
          data: reminder
        });
      });

      data.tasks.filter(t => t.status !== 'completed' && t.dueTsUtc).forEach((task, index) => {
        allItems.push({
          type: 'task',
          index: index,
          date: new Date(task.dueTsUtc),
          data: task
        });
      });

      // Sort by date
      allItems.sort((a, b) => a.date - b.date);

      // Group by date
      const grouped = {};
      allItems.forEach(item => {
        const dateKey = item.date.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        if (!grouped[dateKey]) grouped[dateKey] = [];
        grouped[dateKey].push(item);
      });

      // If priorityFilter is set, sort groups to show filtered items first
      let sortedGroups = Object.entries(grouped);
      if (priorityFilter) {
        sortedGroups.sort(([dateKeyA, itemsA], [dateKeyB, itemsB]) => {
          // Check if groups contain filtered items
          const aHasFiltered = itemsA.some(item => item.type === priorityFilter);
          const bHasFiltered = itemsB.some(item => item.type === priorityFilter);

          if (aHasFiltered && !bHasFiltered) return -1;
          if (!aHasFiltered && bHasFiltered) return 1;

          // If both have or both don't have filtered items, maintain date order
          // Compare dates of first items in each group
          return itemsA[0].date - itemsB[0].date;
        });
      }

      let html = '';
      sortedGroups.forEach(([dateKey, items]) => {
        // Within each date group, sort filtered items first
        if (priorityFilter) {
          items.sort((a, b) => {
            const aMatch = a.type === priorityFilter;
            const bMatch = b.type === priorityFilter;
            if (aMatch && !bMatch) return -1;
            if (!aMatch && bMatch) return 1;
            return a.date - b.date;
          });
        }

        html += `<div class="mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-3 border-b-2 border-purple-200 pb-2">${dateKey}</h3>
          <div class="space-y-3">`;

        items.forEach(item => {
          const time = formatTime(item.date);
          if (item.type === 'event') {
            html += `<div onclick="showEventModal(${item.index}, 'event')" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border-r-4 border-blue-500 cursor-pointer hover:shadow-lg transition-all">
              <div class="flex items-center gap-3">
                <div class="text-2xl">ğŸ“…</div>
                <div class="flex-1">
                  <div class="font-bold text-gray-800">${escapeHtml(item.data.title)}</div>
                  <div class="text-sm text-gray-600">${time}${item.data.location ? ` â€¢ ${escapeHtml(item.data.location)}` : ''}</div>
                </div>
              </div>
            </div>`;
          } else if (item.type === 'reminder') {
            html += `<div onclick="showEventModal(${item.index}, 'reminder')" class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-4 border-r-4 border-amber-500 cursor-pointer hover:shadow-lg transition-all">
              <div class="flex items-center gap-3">
                <div class="text-2xl">â°</div>
                <div class="flex-1">
                  <div class="font-bold text-gray-800">${escapeHtml(item.data.title)}</div>
                  <div class="text-sm text-gray-600">${time}${item.data.recurrence ? ` â€¢ ${item.data.recurrence}` : ''}</div>
                </div>
              </div>
            </div>`;
          } else {
            const priorityEmoji = { urgent: 'ğŸ”´', high: 'ğŸŸ ', normal: 'ğŸ”µ', low: 'ğŸŸ¢' }[item.data.priority] || 'ğŸ”µ';
            html += `<div onclick="showEventModal(${item.index}, 'task')" class="bg-white rounded-xl p-4 border-r-4 border-green-500 cursor-pointer hover:shadow-lg transition-all">
              <div class="flex items-center gap-3">
                <div class="text-2xl">${priorityEmoji}</div>
                <div class="flex-1">
                  <div class="font-bold text-gray-800">${escapeHtml(item.data.title)}</div>
                  <div class="text-sm text-gray-600">${getPriorityText(item.data.priority)}</div>
                </div>
              </div>
            </div>`;
          }
        });

        html += '</div></div>';
      });

      if (html === '') {
        html = `<div class="text-center py-12">
          <div class="text-6xl mb-4">ğŸ“‹</div>
          <p class="text-gray-600 text-lg">××™×Ÿ ×¤×¨×™×˜×™× ×§×¨×•×‘×™×</p>
        </div>`;
      }

      container.innerHTML = html;
    }

    // Modal functions
    function showEventModal(index, type) {
      let item, content;

      if (type === 'event') {
        item = data.events[index];
        const start = new Date(item.startTsUtc);
        const end = item.endTsUtc ? new Date(item.endTsUtc) : null;
        const isToday = isDateToday(start);
        const isPast = start < new Date();

        content = `
          <div class="gradient-bg p-6 rounded-t-3xl">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                <span>ğŸ“…</span>
                <span>×¤×¨×˜×™ ××™×¨×•×¢</span>
              </h2>
              <button onclick="closeModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            ${isToday ? '<div class="bg-red-500 text-white text-sm px-3 py-1 rounded-full inline-block font-bold">×”××™×¨×•×¢ ×”×™×•×! ğŸ¯</div>' : ''}
            ${isPast ? '<div class="bg-gray-500 text-white text-sm px-3 py-1 rounded-full inline-block">×¢×‘×¨</div>' : ''}
          </div>

          <div class="p-6 space-y-6">
            <div>
              <h3 class="text-3xl font-bold text-gray-900 mb-2">${escapeHtml(item.title)}</h3>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-blue-50 rounded-xl p-4">
                <div class="text-sm text-blue-600 font-medium mb-1">ğŸ“… ×ª××¨×™×š ×”×ª×—×œ×”</div>
                <div class="text-lg font-bold text-blue-900">${formatDate(start)}</div>
                ${!item.isAllDay ? `<div class="text-md text-blue-700 mt-1">ğŸ• ${formatTime(start)}</div>` : '<div class="text-md text-blue-700 mt-1">â° ×›×œ ×”×™×•×</div>'}
              </div>

              ${end ? `
                <div class="bg-indigo-50 rounded-xl p-4">
                  <div class="text-sm text-indigo-600 font-medium mb-1">ğŸ“… ×ª××¨×™×š ×¡×™×•×</div>
                  <div class="text-lg font-bold text-indigo-900">${formatDate(end)}</div>
                  <div class="text-md text-indigo-700 mt-1">ğŸ• ${formatTime(end)}</div>
                </div>
              ` : ''}
            </div>

            ${item.location ? `
              <div class="bg-purple-50 rounded-xl p-4">
                <div class="text-sm text-purple-600 font-medium mb-2">ğŸ“ ××™×§×•×</div>
                <div class="text-lg text-purple-900">${escapeHtml(item.location)}</div>
              </div>
            ` : ''}

            ${item.notes ? `
              <div class="bg-gray-50 rounded-xl p-4">
                <div class="text-sm text-gray-600 font-medium mb-2">ğŸ’¬ ×”×¢×¨×•×ª</div>
                <div class="text-gray-800 whitespace-pre-wrap">${escapeHtml(item.notes)}</div>
              </div>
            ` : ''}

            <div class="flex gap-3 pt-4">
              <button onclick="copyEventToClipboard(${index}, 'event')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 px-6 py-3 rounded-xl font-medium transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                ×”×¢×ª×§
              </button>
              <button onclick="closeModal()" class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
                ×¡×’×•×¨
              </button>
            </div>
          </div>
        `;
      } else if (type === 'reminder') {
        item = data.reminders[index];
        const due = new Date(item.dueTsUtc);
        const isPast = due < new Date();
        const isUpcoming = !isPast && (due - new Date()) < 24 * 60 * 60 * 1000;

        content = `
          <div class="bg-gradient-to-r from-amber-500 to-orange-600 p-6 rounded-t-3xl">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                <span>â°</span>
                <span>×¤×¨×˜×™ ×ª×–×›×•×¨×ª</span>
              </h2>
              <button onclick="closeModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            ${isUpcoming ? '<div class="bg-orange-600 text-white text-sm px-3 py-1 rounded-full inline-block font-bold animate-pulse">×§×¨×•×‘! ğŸ””</div>' : ''}
            ${item.status === 'cancelled' ? '<div class="bg-gray-500 text-white text-sm px-3 py-1 rounded-full inline-block">××‘×•×˜×œ</div>' : ''}
            ${item.recurrence ? '<div class="bg-blue-500 text-white text-sm px-3 py-1 rounded-full inline-block">×ª×–×›×•×¨×ª ×—×•×–×¨×ª ğŸ”„</div>' : ''}
          </div>

          <div class="p-6 space-y-6">
            <div>
              <h3 class="text-3xl font-bold text-gray-900 mb-2">${escapeHtml(item.title)}</h3>
            </div>

            <div class="bg-amber-50 rounded-xl p-4">
              <div class="text-sm text-amber-600 font-medium mb-1">â° ××•×¢×“ ×”×ª×–×›×•×¨×ª</div>
              <div class="text-lg font-bold text-amber-900">${formatDate(due)}</div>
              <div class="text-md text-amber-700 mt-1">ğŸ• ${formatTime(due)}</div>
            </div>

            ${item.recurrence ? `
              <div class="bg-blue-50 rounded-xl p-4">
                <div class="text-sm text-blue-600 font-medium mb-2">ğŸ”„ ×—×–×¨×ª×™×•×ª</div>
                <div class="text-lg text-blue-900">${escapeHtml(item.recurrence)}</div>
              </div>
            ` : ''}

            <div class="bg-gray-50 rounded-xl p-4">
              <div class="text-sm text-gray-600 font-medium mb-2">â„¹ï¸ ××¦×‘</div>
              <div class="text-lg ${item.status === 'pending' ? 'text-green-600' : 'text-gray-600'}">${item.status === 'pending' ? '×¤×¢×™×œ×” âœ“' : item.status === 'cancelled' ? '××‘×•×˜×œ×ª' : '×”×•×©×œ××”'}</div>
            </div>

            <div class="flex gap-3 pt-4">
              <button onclick="copyEventToClipboard(${index}, 'reminder')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 px-6 py-3 rounded-xl font-medium transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                ×”×¢×ª×§
              </button>
              <button onclick="closeModal()" class="flex-1 bg-gradient-to-r from-amber-500 to-orange-600 text-white px-6 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
                ×¡×’×•×¨
              </button>
            </div>
          </div>
        `;
      } else if (type === 'task') {
        item = data.tasks[index];
        const priorityEmoji = {
          urgent: 'ğŸ”´',
          high: 'ğŸŸ ',
          normal: 'ğŸ”µ',
          low: 'ğŸŸ¢'
        }[item.priority] || 'ğŸ”µ';
        const isOverdue = item.dueTsUtc && new Date(item.dueTsUtc) < new Date();

        content = `
          <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 rounded-t-3xl">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                <span>âœ…</span>
                <span>×¤×¨×˜×™ ××©×™××”</span>
              </h2>
              <button onclick="closeModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            ${item.status === 'in_progress' ? '<div class="bg-blue-500 text-white text-sm px-3 py-1 rounded-full inline-block">×‘×‘×™×¦×•×¢ ğŸš€</div>' : ''}
            ${isOverdue ? '<div class="bg-red-500 text-white text-sm px-3 py-1 rounded-full inline-block animate-pulse">×‘××™×—×•×¨! âš ï¸</div>' : ''}
          </div>

          <div class="p-6 space-y-6">
            <div>
              <h3 class="text-3xl font-bold text-gray-900 mb-2 flex items-center gap-2">
                <span>${priorityEmoji}</span>
                <span>${escapeHtml(item.title)}</span>
              </h3>
            </div>

            ${item.description ? `
              <div class="bg-gray-50 rounded-xl p-4">
                <div class="text-sm text-gray-600 font-medium mb-2">ğŸ“ ×ª×™××•×¨</div>
                <div class="text-gray-800 whitespace-pre-wrap">${escapeHtml(item.description)}</div>
              </div>
            ` : ''}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-purple-50 rounded-xl p-4">
                <div class="text-sm text-purple-600 font-medium mb-1">ğŸ·ï¸ ×¢×“×™×¤×•×ª</div>
                <div class="text-lg font-bold text-purple-900">${getPriorityText(item.priority)}</div>
              </div>

              ${item.dueTsUtc ? `
                <div class="bg-blue-50 rounded-xl p-4">
                  <div class="text-sm text-blue-600 font-medium mb-1">ğŸ“… ×ª××¨×™×š ×™×¢×“</div>
                  <div class="text-lg font-bold text-blue-900">${formatDate(new Date(item.dueTsUtc))}</div>
                </div>
              ` : ''}
            </div>

            <div class="bg-green-50 rounded-xl p-4">
              <div class="text-sm text-green-600 font-medium mb-2">â„¹ï¸ ×¡×˜×˜×•×¡</div>
              <div class="text-lg text-green-900">${item.status === 'in_progress' ? '×‘×‘×™×¦×•×¢ ğŸš€' : item.status === 'completed' ? '×”×•×©×œ××” âœ“' : '×××ª×™× ×”'}</div>
            </div>

            <div class="flex gap-3 pt-4">
              <button onclick="copyEventToClipboard(${index}, 'task')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 px-6 py-3 rounded-xl font-medium transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                ×”×¢×ª×§
              </button>
              <button onclick="closeModal()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl font-medium hover:shadow-lg transition-all">
                ×¡×’×•×¨
              </button>
            </div>
          </div>
        `;
      }

      document.getElementById('modalBody').innerHTML = content;
      document.getElementById('itemModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal(event) {
      // Close if clicking on backdrop or close button
      if (!event || event.target.id === 'itemModal' || event.target.closest('button')) {
        document.getElementById('itemModal').classList.remove('active');
        document.body.style.overflow = 'auto';
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Today's Overview functionality
    function renderTodayOverview() {
      const container = document.getElementById('today-content');
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
      const next3Hours = new Date(now.getTime() + 3 * 60 * 60 * 1000);

      // Find today's urgent items
      const urgentEvents = [];
      const overdueItems = [];
      const todayItems = [];

      // Check events happening in next 3 hours
      data.events.forEach((event, index) => {
        const eventTime = new Date(event.startTsUtc);
        if (eventTime >= now && eventTime <= next3Hours) {
          urgentEvents.push({type: 'event', data: event, index, time: eventTime});
        } else if (eventTime >= todayStart && eventTime <= todayEnd) {
          todayItems.push({type: 'event', data: event, index, time: eventTime});
        }
      });

      // Check reminders happening in next 3 hours
      data.reminders.forEach((reminder, index) => {
        if (reminder.status === 'cancelled') return;
        const reminderTime = new Date(reminder.dueTsUtc);
        if (reminderTime >= now && reminderTime <= next3Hours) {
          urgentEvents.push({type: 'reminder', data: reminder, index, time: reminderTime});
        } else if (reminderTime >= todayStart && reminderTime <= todayEnd) {
          todayItems.push({type: 'reminder', data: reminder, index, time: reminderTime});
        }
      });

      // Check overdue tasks
      data.tasks.forEach((task, index) => {
        if (task.status === 'completed') return;
        if (task.dueTsUtc) {
          const taskTime = new Date(task.dueTsUtc);
          if (taskTime < now) {
            overdueItems.push({type: 'task', data: task, index, time: taskTime});
          } else if (taskTime >= todayStart && taskTime <= todayEnd) {
            todayItems.push({type: 'task', data: task, index, time: taskTime});
          }
        }
      });

      let html = '';

      // Urgent items (next 3 hours)
      if (urgentEvents.length > 0) {
        html += '<div class="bg-red-50 border-r-4 border-red-500 rounded-lg p-4 mb-3">';
        html += '<h3 class="font-bold text-red-900 mb-2 flex items-center gap-2"><span>ğŸ”¥</span><span>×“×—×•×£ - 3 ×”×©×¢×•×ª ×”×§×¨×•×‘×•×ª</span></h3>';
        urgentEvents.forEach(item => {
          if (item.type === 'event') {
            html += `<div class="text-sm text-red-800 mb-1">ğŸ“… <strong>${escapeHtml(item.data.title)}</strong> - ${formatTime(item.time)}</div>`;
          } else {
            html += `<div class="text-sm text-red-800 mb-1">â° <strong>${escapeHtml(item.data.title)}</strong> - ${formatTime(item.time)}</div>`;
          }
        });
        html += '</div>';
      }

      // Overdue tasks
      if (overdueItems.length > 0) {
        html += '<div class="bg-orange-50 border-r-4 border-orange-500 rounded-lg p-4 mb-3">';
        html += `<h3 class="font-bold text-orange-900 mb-2 flex items-center gap-2"><span>âš ï¸</span><span>×‘××™×—×•×¨ (${overdueItems.length})</span></h3>`;
        overdueItems.slice(0, 3).forEach(item => {
          const priorityEmoji = {urgent: 'ğŸ”´', high: 'ğŸŸ ', normal: 'ğŸ”µ', low: 'ğŸŸ¢'}[item.data.priority] || 'ğŸ”µ';
          html += `<div class="text-sm text-orange-800 mb-1">${priorityEmoji} <strong>${escapeHtml(item.data.title)}</strong></div>`;
        });
        if (overdueItems.length > 3) {
          html += `<div class="text-xs text-orange-600 mt-2">×•×¢×•×“ ${overdueItems.length - 3} ××©×™××•×ª...</div>`;
        }
        html += '</div>';
      }

      // Today's schedule
      if (todayItems.length > 0) {
        html += '<div class="bg-blue-50 border-r-4 border-blue-500 rounded-lg p-4">';
        html += `<h3 class="font-bold text-blue-900 mb-2 flex items-center gap-2"><span>ğŸ“…</span><span>×œ×•×— ×”×™×•× (${todayItems.length})</span></h3>`;
        todayItems.sort((a, b) => a.time - b.time).slice(0, 5).forEach(item => {
          let emoji = item.type === 'event' ? 'ğŸ“…' : item.type === 'reminder' ? 'â°' : 'âœ…';
          html += `<div class="text-sm text-blue-800 mb-1">${emoji} <strong>${escapeHtml(item.data.title)}</strong> - ${formatTime(item.time)}</div>`;
        });
        if (todayItems.length > 5) {
          html += `<div class="text-xs text-blue-600 mt-2">×•×¢×•×“ ${todayItems.length - 5} ×¤×¨×™×˜×™×...</div>`;
        }
        html += '</div>';
      }

      if (html === '') {
        html = '<div class="text-center py-6"><div class="text-4xl mb-2">âœ¨</div><p class="text-gray-600">×”×™×•× × ×¨××” ×¨×’×•×¢! ××™×Ÿ ×¤×¨×™×˜×™× ×“×—×•×¤×™×</p></div>';
      }

      container.innerHTML = html;
    }

    // Search and Filter functionality
    let activeFilters = {events: true, reminders: true, tasks: true};

    function toggleFilter(type) {
      activeFilters[type] = !activeFilters[type];
      const btn = document.getElementById(`filter-${type}`);
      if (activeFilters[type]) {
        btn.classList.add('filter-active');
      } else {
        btn.classList.remove('filter-active');
      }
      applyFilters();
    }

    function applyFilters() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();

      // Filter events
      let filteredEvents = data.events;
      if (!activeFilters.events) {
        filteredEvents = [];
      } else if (searchTerm) {
        filteredEvents = data.events.filter(e =>
          e.title.toLowerCase().includes(searchTerm) ||
          (e.location && e.location.toLowerCase().includes(searchTerm)) ||
          (e.notes && e.notes.toLowerCase().includes(searchTerm))
        );
      }

      // Filter reminders
      let filteredReminders = data.reminders;
      if (!activeFilters.reminders) {
        filteredReminders = [];
      } else if (searchTerm) {
        filteredReminders = data.reminders.filter(r =>
          r.title.toLowerCase().includes(searchTerm)
        );
      }

      // Filter tasks
      let filteredTasks = data.tasks;
      if (!activeFilters.tasks) {
        filteredTasks = [];
      } else if (searchTerm) {
        filteredTasks = data.tasks.filter(t =>
          t.title.toLowerCase().includes(searchTerm) ||
          (t.description && t.description.toLowerCase().includes(searchTerm))
        );
      }

      // Re-render filtered data
      renderEvents(filteredEvents);
      renderReminders(filteredReminders);
      renderTasks(filteredTasks);

      // Also update agenda view if it's active
      const agendaSection = document.getElementById('section-agenda');
      if (!agendaSection.classList.contains('hidden')) {
        renderAgendaView();
      }
    }

    // Quick Actions - Copy to clipboard
    function copyEventToClipboard(index, type) {
      let text = '';
      if (type === 'event') {
        const event = data.events[index];
        const start = new Date(event.startTsUtc);
        text = `××™×¨×•×¢: ${event.title}\n`;
        text += `×ª××¨×™×š: ${formatDate(start)}\n`;
        if (!event.isAllDay) text += `×©×¢×”: ${formatTime(start)}\n`;
        if (event.location) text += `××™×§×•×: ${event.location}\n`;
        if (event.notes) text += `×”×¢×¨×•×ª: ${event.notes}\n`;
      } else if (type === 'reminder') {
        const reminder = data.reminders[index];
        const due = new Date(reminder.dueTsUtc);
        text = `×ª×–×›×•×¨×ª: ${reminder.title}\n`;
        text += `×ª××¨×™×š: ${formatDate(due)}\n`;
        text += `×©×¢×”: ${formatTime(due)}\n`;
        if (reminder.recurrence) text += `×—×–×¨×ª×™×•×ª: ${reminder.recurrence}\n`;
      } else if (type === 'task') {
        const task = data.tasks[index];
        text = `××©×™××”: ${task.title}\n`;
        if (task.description) text += `×ª×™××•×¨: ${task.description}\n`;
        text += `×¢×“×™×¤×•×ª: ${getPriorityText(task.priority)}\n`;
        if (task.dueTsUtc) text += `×ª××¨×™×š ×™×¢×“: ${formatDate(new Date(task.dueTsUtc))}\n`;
      }

      navigator.clipboard.writeText(text).then(() => {
        showToast('×”×•×¢×ª×§ ×œ×œ×•×— ×‘×”×¦×œ×—×”! âœ“', 'success');
      }).catch(err => {
        console.error('Failed to copy:', err);
        showToast('×©×’×™××” ×‘×”×¢×ª×§×”. ×× × × ×¡×” ×©×•×‘.', 'error');
      });
    }

    // Toast Notification System
    function showToast(message, type = 'info') {
      // Remove existing toasts
      document.querySelectorAll('.toast').forEach(toast => toast.remove());

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹';
      const iconColor = type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-blue-600';

      toast.innerHTML = `
        <div class="text-2xl ${iconColor}">${icon}</div>
        <div class="flex-1">
          <div class="font-medium text-gray-800">${message}</div>
        </div>
        <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      `;

      document.body.appendChild(toast);

      // Auto remove after 3 seconds
      setTimeout(() => {
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Update Stat Card with Animation
    function updateStatCard(statId, value, progressId, percentage) {
      const statEl = document.getElementById(statId);
      const progressEl = document.getElementById(progressId);

      // Animate number
      let current = 0;
      const increment = value / 20;
      const timer = setInterval(() => {
        current += increment;
        if (current >= value) {
          statEl.textContent = value;
          clearInterval(timer);
        } else {
          statEl.textContent = Math.floor(current);
        }
      }, 30);

      // Animate progress bar
      setTimeout(() => {
        progressEl.style.width = `${percentage}%`;
      }, 100);
    }

    // Mobile Collapsible Toggle
    function toggleMobileSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.toggle('expanded');
      }
    }

    // FAB and Bottom Sheet Menu Functions
    function openAddMenu() {
      const overlay = document.getElementById('add-menu-overlay');
      const menu = document.getElementById('add-menu');

      overlay.classList.remove('hidden');
      menu.classList.remove('hidden');

      // Trigger animation
      setTimeout(() => {
        menu.classList.remove('translate-y-full');
        overlay.classList.remove('opacity-0');
      }, 10);

      // Prevent body scroll
      document.body.style.overflow = 'hidden';

      // Haptic feedback for mobile
      if ('vibrate' in navigator) {
        navigator.vibrate(10);
      }
    }

    function closeAddMenu() {
      const overlay = document.getElementById('add-menu-overlay');
      const menu = document.getElementById('add-menu');

      menu.classList.add('translate-y-full');
      overlay.classList.add('opacity-0');

      setTimeout(() => {
        overlay.classList.add('hidden');
        menu.classList.add('hidden');
        document.body.style.overflow = '';
      }, 300);
    }

    function openAddModalFromSheet(type) {
      closeAddMenu();

      // Wait for bottom sheet to close, then open modal
      setTimeout(() => {
        // TODO: Connect to your existing add modal functions
        // For now, just show an alert
        alert(`Opening ${type} modal - Connect this to your existing add modal logic`);

        // Example: You would call your existing modal functions here
        // if (type === 'event') openEventModal();
        // if (type === 'reminder') openReminderModal();
        // if (type === 'task') openTaskModal();
      }, 350);
    }

    // Show/hide FAB based on active tab
    function updateFABVisibility() {
      const fab = document.getElementById('add-fab');
      const currentTab = document.querySelector('.tab-btn.tab-active')?.id;

      // Show FAB on agenda, events, reminders, and tasks tabs
      const showFABTabs = ['tab-agenda', 'tab-events', 'tab-reminders', 'tab-tasks'];

      if (showFABTabs.includes(currentTab)) {
        fab.style.display = 'flex';
      } else {
        fab.style.display = 'none';
      }
    }

    // Update showTab function to handle FAB visibility
    const originalShowTab = showTab;
    showTab = function(tab) {
      originalShowTab(tab);
      updateFABVisibility();
    };

    // Swipe down to close bottom sheet
    let touchStartY = 0;
    let touchStartTime = 0;

    const addMenu = document.getElementById('add-menu');
    if (addMenu) {
      addMenu.addEventListener('touchstart', (e) => {
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();
      });

      addMenu.addEventListener('touchmove', (e) => {
        const touchEndY = e.touches[0].clientY;
        const diff = touchEndY - touchStartY;
        const time = Date.now() - touchStartTime;

        // Swipe down threshold: 50px in less than 500ms
        if (diff > 50 && time < 500) {
          closeAddMenu();
        }
      });
    }

    // Keyboard shortcut: Cmd+N or Ctrl+N to open add menu
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
        e.preventDefault();
        const fab = document.getElementById('add-fab');
        if (fab.style.display !== 'none') {
          openAddMenu();
        }
      }

      // Escape to close bottom sheet
      if (e.key === 'Escape') {
        const menu = document.getElementById('add-menu');
        if (!menu.classList.contains('hidden')) {
          closeAddMenu();
        }
      }
    });

    // Initialize FAB visibility on page load
    window.addEventListener('load', () => {
      updateFABVisibility();
    });
  </script>
</body>
</html>
