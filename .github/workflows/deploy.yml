name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: whatsapp_assistant_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 7432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 7379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 7432
      POSTGRES_DB: whatsapp_assistant_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      REDIS_HOST: localhost
      REDIS_PORT: 7379

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run tests
        run: npm test
        continue-on-error: false

      - name: ğŸ”¨ Build TypeScript
        run: npm run build

  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸš€ Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          script: |
            /root/deploy.sh

      - name: âœ… Deployment notification
        if: success()
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "Server: ${{ secrets.SSH_HOST }}"
          echo "Time: $(date)"

      - name: âŒ Deployment failed notification
        if: failure()
        run: |
          echo "âš ï¸ Deployment failed!"
          echo "Check the logs above for details"
          exit 1

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: ğŸ¥ Check server health
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "Checking PM2 status..."
            pm2 status ultrathink

            echo ""
            echo "Checking if process is online..."
            if pm2 status | grep -q "ultrathink.*online"; then
              echo "âœ… Process is running"
              exit 0
            else
              echo "âŒ Process is not running!"
              exit 1
            fi
