name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build TypeScript
      run: npm run build

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 167.71.145.9 >> ~/.ssh/known_hosts

    - name: Deploy to production
      run: |
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='wwebjs_auth' \
          --exclude='sessions' \
          --exclude='.wwebjs_cache' \
          --exclude='*.log' \
          dist/ root@167.71.145.9:~/wAssitenceBot/dist/

    - name: Update git repository on production
      run: |
        ssh root@167.71.145.9 "cd ~/wAssitenceBot && git fetch origin && git reset --hard origin/main"

    - name: Rebuild TypeScript on production
      run: |
        ssh root@167.71.145.9 "cd ~/wAssitenceBot && npm run build"

    - name: Restart PM2
      run: |
        ssh root@167.71.145.9 "cd ~/wAssitenceBot && pm2 restart ultrathink"

    - name: Verify deployment
      run: |
        ssh root@167.71.145.9 "cd ~/wAssitenceBot && pm2 status ultrathink"

    - name: Get latest commit info
      if: success()
      run: |
        echo "✅ Successfully deployed commit: $(git log -1 --pretty=%B)"

    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Deployment failed! Check logs above."
